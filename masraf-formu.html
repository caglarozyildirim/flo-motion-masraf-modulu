<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masraf Formu - FLOConnect</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
        <div class="logo">FLO<span style="font-weight: 300;">Connect</span></div>
        <div class="header-actions">
            <button class="notification-btn">üîî Bildirimler</button>
        </div>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar - Employee View -->
        <aside class="sidebar" id="sidebarEmployee">
            <button class="sidebar-close" onclick="closeMobileMenu()">‚úï</button>
            <div class="user-profile">
                <div class="user-avatar">BT</div>
                <div class="user-name">Berat Tanrƒ±verdi</div>
                <div class="user-title">Kƒ±demli Uzman</div>
                <div class="user-role">√úr√ºn Tasarƒ±m/UX M√ºd.</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="calisan-anasayfa.html" class="nav-link">
                        <span class="nav-icon">üè†</span>
                        Anasayfa
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-formu.html" class="nav-link active">
                        <span class="nav-icon">üßæ</span>
                        Yeni Masraf Giri≈üi
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html" class="nav-link">
                        <span class="nav-icon">üìã</span>
                        Masraf Taleplerim
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="window.location.href='index.html'">
                üö™ √áƒ±kƒ±≈ü Yap
            </button>
        </aside>

        <!-- Sidebar - Manager View -->
        <aside class="sidebar" id="sidebarManager" style="display: none;">
            <button class="sidebar-close" onclick="closeMobileMenu()">‚úï</button>
            <div class="user-profile">
                <div class="user-avatar" style="background: linear-gradient(135deg, var(--primary-burgundy), #A0516D);">MY</div>
                <div class="user-name">Mehmet Yƒ±lmaz</div>
                <div class="user-title">Dijital √úr√ºnler Direkt√∂r√º</div>
                <div class="user-role" style="background: linear-gradient(135deg, var(--primary-burgundy), #A0516D); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px;">4. Derece Onay Yetkisi</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="yonetici-anasayfa.html" class="nav-link">
                        <span class="nav-icon">üè†</span>
                        Anasayfa
                    </a>
                </li>
                <li class="nav-item">
                    <a href="onay-listesi.html" class="nav-link">
                        <span class="nav-icon">‚è≥</span>
                        Onay Bekleyenler
                        <span style="background: var(--warning-red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: auto;">7</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html?view=all" class="nav-link">
                        <span class="nav-icon">üìã</span>
                        Masraflarƒ±m
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html?view=team" class="nav-link">
                        <span class="nav-icon">üë•</span>
                        Ekip Masraflarƒ±
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-formu.html?role=manager" class="nav-link active">
                        <span class="nav-icon">üßæ</span>
                        Masraf Giri≈üi
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="window.location.href='index.html'">
                üö™ √áƒ±kƒ±≈ü Yap
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="calisan-anasayfa.html">Anasayfa</a>
                <span>‚Ä∫</span>
                <span>Yeni Masraf Giri≈üi</span>
            </div>

            <h1 class="page-title">Yeni Masraf Giri≈üi</h1>

            <!-- Warning Alert -->
            <div class="alert alert-warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>√ñnemli:</strong> Fi≈ü veya fatura g√∂rselini y√ºkleyiniz. OCR sistemi belgenizi otomatik olarak okuyacaktƒ±r.
                    Okunan bilgileri kontrol edip onaylamanƒ±z gerekmektedir.
                </div>
            </div>

            <div class="form-container">
                <!-- Section 1: Belge Y√ºkleme -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">1</span>
                        Belge Y√ºkleme (OCR)
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Belge T√ºr√º</label>
                            <select class="form-select" id="belgeTuru">
                                <option value="">Se√ßiniz...</option>
                                <option value="fatura">Fatura</option>
                                <option value="tevkifatli">Tevkifatlƒ± Fatura</option>
                                <option value="fis">Yazar Kasa / Perakende Satƒ±≈ü Fi≈üi</option>
                                <option value="yurtdisi">Yurtdƒ±≈üƒ± Faturasƒ±</option>
                                <option value="dekont">Dekont / Har√ß / Makbuz</option>
                                <option value="su">Su Faturasƒ±</option>
                                <option value="gider_pusulasi">Gider Pusulasƒ±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Masraf Tipi</label>
                            <select class="form-select" id="masrafTipi">
                                <option value="">Se√ßiniz...</option>
                                <option value="normal">Normal Masraf</option>
                                <option value="seyahat">Seyahat Masrafƒ±</option>
                                <option value="kredi_karti">Kredi Kartƒ± Masrafƒ±</option>
                                <option value="kiralama">Kiralama Faturasƒ±</option>
                            </select>
                        </div>
                    </div>

                    <!-- Belge G√∂rseli Preview -->
                    <div class="document-preview-card" id="documentPreviewCard">
                        <h3 class="preview-title">üñºÔ∏è Belge G√∂rseli (OCR ile Okundu)</h3>
                        <div class="document-preview-container">
                            <!-- Sim√ºle edilmi≈ü fi≈ü g√∂rseli -->
                            <div class="receipt-simple" id="receiptSimple">
                                <div class="receipt-simple-header">
                                    <strong class="receipt-simple-company">KARADENIZ SOFRASI</strong>
                                    <span class="receipt-simple-sub">Restoran & Lokanta</span>
                                </div>
                                <div class="receipt-simple-divider"></div>
                                <div class="receipt-simple-info">
                                    VKN: 1234567890<br>
                                    Tarih: 09.12.2024 13:45<br>
                                    Fi≈ü No: YKF-2024-847521
                                </div>
                                <div class="receipt-simple-divider"></div>
                                <div class="receipt-simple-items">
                                    <div class="receipt-simple-item">
                                        <span>2x Karƒ±≈üƒ±k Izgara</span>
                                        <span>‚Ç∫380.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>2x Pilav</span>
                                        <span>‚Ç∫60.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>2x ƒ∞√ßecek</span>
                                        <span>‚Ç∫50.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>1x K√ºnefe</span>
                                        <span>‚Ç∫95.00</span>
                                    </div>
                                </div>
                                <div class="receipt-simple-totals">
                                    <div class="receipt-simple-item">
                                        <span>KDV (%10)</span>
                                        <span>‚Ç∫53.18</span>
                                    </div>
                                    <div class="receipt-simple-item total">
                                        <strong>TOPLAM</strong>
                                        <strong>‚Ç∫585.00</strong>
                                    </div>
                                </div>
                                <div class="receipt-simple-footer">
                                    * TE≈ûEKK√úRLER *<br>
                                    Bu belge mali deƒüer ta≈üƒ±r
                                </div>
                            </div>

                            <div class="ocr-confidence-badge">
                                <span>ü§ñ OCR G√ºven Skoru:</span>
                                <span class="confidence-tag" id="ocrConfidenceTag">%94 Ba≈üarƒ±lƒ±</span>
                            </div>
                        </div>

                        <div class="document-actions">
                            <button class="btn-action-secondary" onclick="retakePhoto()">
                                üîÑ Farklƒ± Belge Y√ºkle
                            </button>
                            <button class="btn-action-primary" onclick="processOCR()">
                                ‚ú® OCR ile Tekrar Oku
                            </button>
                        </div>
                    </div>

                    <!-- OCR Processing Animation -->
                    <div class="ocr-processing" id="ocrProcessing" style="display: none;">
                        <div class="processing-animation">
                            <div class="scan-line"></div>
                            <div class="processing-icon">üîç</div>
                        </div>
                        <div class="processing-text">Belge Okunuyor...</div>
                        <div class="processing-steps">
                            <div class="step-item" id="step1">
                                <span class="step-dot"></span>
                                <span>G√∂r√ºnt√º analiz ediliyor...</span>
                            </div>
                            <div class="step-item" id="step2">
                                <span class="step-dot"></span>
                                <span>Metin tanƒ±nƒ±yor...</span>
                            </div>
                            <div class="step-item" id="step3">
                                <span class="step-dot"></span>
                                <span>Veriler √ßƒ±karƒ±lƒ±yor...</span>
                            </div>
                            <div class="step-item" id="step4">
                                <span class="step-dot"></span>
                                <span>Form dolduruluyor...</span>
                            </div>
                        </div>
                    </div>

                    <!-- OCR Success Result -->
                    <div class="ocr-success" id="ocrSuccess" style="display: none;">
                        <div class="success-header">
                            <div class="success-icon">‚úÖ</div>
                            <div class="success-text">
                                <h3>OCR Ba≈üarƒ±lƒ±!</h3>
                                <p>Belge bilgileri otomatik olarak dolduruldu</p>
                            </div>
                            <div class="confidence-score">
                                <div class="score-circle">
                                    <span class="score-value">94%</span>
                                </div>
                                <span class="score-label">Doƒüruluk</span>
                            </div>
                        </div>
                        <div class="ocr-extracted-preview">
                            <div class="extracted-item">
                                <span class="extracted-label">Firma:</span>
                                <span class="extracted-value">KARADENIZ SOFRASI</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Tarih:</span>
                                <span class="extracted-value">09.12.2024</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Tutar:</span>
                                <span class="extracted-value highlight">‚Ç∫585.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Area (Yeni Belge Y√ºkleme) -->
                    <div class="file-upload-area collapsed" id="uploadArea">
                        <input type="file" id="fileInput" accept="image/*,.pdf" multiple>
                        <div class="upload-icon">üì§</div>
                        <div class="upload-text">Farklƒ± Bir Belge Y√ºkle</div>
                        <div class="upload-hint">veya tƒ±klayarak dosya se√ßin (JPG, PNG, PDF - Max 10MB)</div>
                    </div>

                    <!-- Uploaded Files List -->
                    <div class="uploaded-files" id="uploadedFiles"></div>
                </div>

                <!-- Section 2: Belge Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">2</span>
                        Belge Bilgileri
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Belge/Fatura No</label>
                            <input type="text" class="form-input" id="belgeNo" placeholder="Otomatik okunacak">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Belge Tarihi</label>
                            <input type="date" class="form-input" id="belgeTarihi">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Firma/Tedarik√ßi Adƒ±</label>
                            <input type="text" class="form-input" id="firmaAdi" placeholder="Otomatik okunacak">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vergi Kimlik No</label>
                            <input type="text" class="form-input" id="vergiNo" placeholder="Otomatik okunacak">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Cari Durumu</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <span class="status-badge status-approved" id="cariDurum">Cari Mevcut</span>
                                <span style="font-size: 13px; color: var(--text-secondary);">SAP Cari Kodu: 320.01.001</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Tutar Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">3</span>
                        Tutar Bilgileri
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Br√ºt Tutar (TL)</label>
                            <input type="number" class="form-input" id="brutTutar" step="0.01" placeholder="0.00" oninput="updateAmountSummary()">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">KDV Oranƒ± (%)</label>
                            <select class="form-select" id="kdvOrani" onchange="updateAmountSummary()">
                                <option value="0">%0</option>
                                <option value="1">%1</option>
                                <option value="10">%10</option>
                                <option value="20" selected>%20</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">KDV Tutarƒ± (TL)</label>
                            <input type="number" class="form-input" id="kdvTutari" step="0.01" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">KDV Hari√ß Tutar (TL)</label>
                            <input type="number" class="form-input" id="netTutar" step="0.01" readonly style="background: #f5f5f5;">
                        </div>
                    </div>

                    <!-- Tevkifat Alanlarƒ± (Tevkifatlƒ± Fatura i√ßin) -->
                    <div id="tevkifatAlanlari" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Tevkifat Oranƒ±</label>
                                <select class="form-select" id="tevkifatOrani" onchange="updateTevkifat()">
                                    <option value="0">Tevkifat Yok</option>
                                    <option value="2/10">2/10 - Yapƒ±m ƒ∞≈üleri</option>
                                    <option value="4/10">4/10 - Temizlik Hizmetleri</option>
                                    <option value="5/10">5/10 - Makine Bakƒ±m</option>
                                    <option value="7/10">7/10 - Et√ºt, Plan Proje</option>
                                    <option value="9/10">9/10 - Yapƒ± Denetim</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tevkifat Tutarƒ± (TL)</label>
                                <input type="number" class="form-input" id="tevkifatTutari" step="0.01" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <span class="alert-icon">‚ÑπÔ∏è</span>
                            <span>Tevkifatlƒ± faturalarda KDV'nin bir kƒ±smƒ± satƒ±cƒ± tarafƒ±ndan beyan edilir.</span>
                        </div>
                    </div>

                    <!-- Ta≈üƒ±t Gideri Ayrƒ±mƒ± (%70 Gider / %30 KKEG) -->
                    <div id="tasitGideriAlanlari" style="display: none;">
                        <div class="alert alert-warning">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div>
                                <strong>Ta≈üƒ±t Gideri Ayrƒ±mƒ±:</strong> Bu masraf ta≈üƒ±t gideri olarak i≈üaretlendi.<br>
                                <small>Tutar otomatik olarak %70 Gider ve %30 KKEG olarak ayrƒ±lacaktƒ±r.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Gider Kƒ±smƒ± (%70)</label>
                                <input type="number" class="form-input" id="giderKismi" step="0.01" readonly style="background: #E8F5E9;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">KKEG Kƒ±smƒ± (%30)</label>
                                <input type="number" class="form-input" id="kkegKismi" step="0.01" readonly style="background: #FFF3E0;">
                            </div>
                        </div>
                    </div>

                    <!-- Yurtdƒ±≈üƒ± Masraf Alanlarƒ± (gizli) -->
                    <div id="yurtdisiAlanlari" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">D√∂viz Tutarƒ±</label>
                                <input type="number" class="form-input" id="yurtdisiTutar" step="0.01" oninput="convertCurrency()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Para Birimi</label>
                                <select class="form-select" id="paraBirimi">
                                    <option value="USD">USD - Amerikan Dolarƒ±</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - ƒ∞ngiliz Sterlini</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kur Oranƒ±</label>
                                <input type="number" class="form-input" id="kurOrani" step="0.0001" oninput="convertCurrency()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TL Kar≈üƒ±lƒ±ƒüƒ±</label>
                                <input type="number" class="form-input" id="tlKarsiligi" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                    </div>

                    <!-- Amount Summary -->
                    <div class="amount-summary">
                        <div class="amount-row">
                            <span>Br√ºt Tutar:</span>
                            <span id="summaryBrut">0.00 TL</span>
                        </div>
                        <div class="amount-row">
                            <span>KDV Tutarƒ±:</span>
                            <span id="summaryKdv">0.00 TL</span>
                        </div>
                        <div class="amount-row">
                            <span>KDV Hari√ß Tutar:</span>
                            <span id="summaryNet">0.00 TL</span>
                        </div>
                        <div class="amount-row total">
                            <span>Toplam Masraf:</span>
                            <span id="summaryTotal">0.00 TL</span>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Masraf Detaylarƒ± -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">4</span>
                        Masraf Detaylarƒ±
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Masraf Merkezi</label>
                            <input type="text" class="form-input" id="masrafMerkezi" value="50G1022 - Dijital √úr√ºnler" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Masraf T√ºr√º / Hesap Kodu</label>
                            <select class="form-select" id="hesapKodu">
                                <option value="">Se√ßiniz...</option>
                                <optgroup label="Genel Y√∂netim Giderleri - Merkez (770)">
                                    <option value="770.01">770.01 - Yemek Giderleri</option>
                                    <option value="770.02">770.02 - Ula≈üƒ±m Giderleri</option>
                                    <option value="770.03">770.03 - Konaklama Giderleri</option>
                                    <option value="770.04">770.04 - Ofis Malzemesi</option>
                                    <option value="770.05">770.05 - Temsil Aƒüƒ±rlama</option>
                                    <option value="770.06">770.06 - Haberle≈üme Giderleri</option>
                                    <option value="770.07">770.07 - Ta≈üƒ±t Giderleri</option>
                                </optgroup>
                                <optgroup label="Pazarlama Satƒ±≈ü Daƒüƒ±tƒ±m - Maƒüazalar (760)">
                                    <option value="760.01">760.01 - Maƒüaza Giderleri</option>
                                    <option value="760.02">760.02 - Tanƒ±tƒ±m Giderleri</option>
                                    <option value="760.03">760.03 - Satƒ±≈ü Promosyon</option>
                                </optgroup>
                                <optgroup label="Ar-Ge / Tasarƒ±m Merkezi (750)">
                                    <option value="750.01">750.01 - Proje Giderleri</option>
                                    <option value="750.02">750.02 - Ara≈ütƒ±rma Giderleri</option>
                                    <option value="750.03">750.03 - Test ve Geli≈ütirme</option>
                                </optgroup>
                                <optgroup label="Teknoloji Teknik Destek (740)">
                                    <option value="740.01">740.01 - Yazƒ±lƒ±m Giderleri</option>
                                    <option value="740.02">740.02 - Donanƒ±m Bakƒ±m</option>
                                    <option value="740.03">740.03 - IT Destek Hizmetleri</option>
                                </optgroup>
                                <optgroup label="Fabrika Giderleri (730)">
                                    <option value="730.01">730.01 - √úretim Giderleri</option>
                                    <option value="730.02">730.02 - Hammadde Giderleri</option>
                                    <option value="730.03">730.03 - Bakƒ±m Onarƒ±m</option>
                                </optgroup>
                                <optgroup label="≈ûirketlerarasƒ± Yansƒ±tmalar (198)">
                                    <option value="198.01">198.01 - FLO Maƒüazacƒ±lƒ±k Yansƒ±tma</option>
                                    <option value="198.02">198.02 - FLO Teknoloji Yansƒ±tma</option>
                                    <option value="198.03">198.03 - Turuncu Yansƒ±tma</option>
                                </optgroup>
                                <optgroup label="Kiralama Giderleri (632)">
                                    <option value="632.04.01">632.04.01 - Maƒüaza Asgari Kira</option>
                                    <option value="632.04.02">632.04.02 - Ortak Y√∂netim Gideri</option>
                                    <option value="632.04.03">632.04.03 - Ciro Kira Gideri</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Proje Kodu (Opsiyonel)</label>
                            <select class="form-select" id="projeKodu">
                                <option value="">Proje se√ßiniz (opsiyonel)...</option>
                                <option value="PRJ001">PRJ001 - E-Ticaret Yenileme</option>
                                <option value="PRJ002">PRJ002 - Mobil Uygulama v2</option>
                                <option value="PRJ003">PRJ003 - CRM Entegrasyonu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">≈ûirket</label>
                            <select class="form-select" id="sirket">
                                <option value="flo_magazacilik">FLO Maƒüazacƒ±lƒ±k</option>
                                <option value="turuncu">Turuncu Ayakkabƒ±</option>
                                <option value="flo_teknoloji">FLO Teknoloji</option>
                                <option value="flo_ic_dis">FLO ƒ∞√ß Dƒ±≈ü Ticaret</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label required">Masraf A√ßƒ±klamasƒ±</label>
                            <textarea class="form-textarea" id="aciklama" placeholder="Masrafƒ±n ne i√ßin yapƒ±ldƒ±ƒüƒ±nƒ± detaylƒ± a√ßƒ±klayƒ±nƒ±z..." required></textarea>
                            <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                                * Bu a√ßƒ±klama hesap e≈üle≈ütirmesinde kullanƒ±lacaktƒ±r. L√ºtfen detaylƒ± yazƒ±nƒ±z.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Onay Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">5</span>
                        Onay Akƒ±≈üƒ± Bilgileri
                    </h2>

                    <div class="alert alert-info">
                        <span class="alert-icon">‚ÑπÔ∏è</span>
                        <div>
                            Masraf tutarƒ±nƒ±za g√∂re onay akƒ±≈üƒ± otomatik belirlenecektir.
                            <strong>7.500 TL</strong> altƒ± masraflar sadece birim m√ºd√ºr√º onayƒ± ile tamamlanƒ±r.
                        </div>
                    </div>

                    <!-- Approval Timeline Preview -->
                    <div class="approval-timeline">
                        <div class="approval-step completed">
                            <div class="step-circle">‚úì</div>
                            <div class="step-label">Talep Olu≈ütur</div>
                            <div class="step-person">Berat Tanrƒ±verdi</div>
                        </div>
                        <div class="approval-step current">
                            <div class="step-circle">1</div>
                            <div class="step-label">Y√∂netici Onayƒ±</div>
                            <div class="step-person">Mehmet Yƒ±lmaz (5.Derece)</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Muhasebe Onayƒ±</div>
                            <div class="step-person">Muhasebe Havuzu</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">SAP Aktarƒ±m</div>
                            <div class="step-person">Otomatik</div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="saveDraft()">
                        üíæ Taslak Kaydet
                    </button>
                    <button type="button" class="btn-outline" onclick="window.history.back()">
                        ƒ∞ptal
                    </button>
                    <button type="button" class="btn-primary" onclick="submitMasrafForm()">
                        üì§ Onaya G√∂nder
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script>
        // ============================================
        // OCR OTOMATƒ∞K DOLDURMA Sƒ∞STEMƒ∞
        // ============================================

        // Farklƒ± belge t√ºrleri i√ßin √∂rnek OCR verileri
        const sampleOCRDatasets = [
            {
                belgeTuru: 'fis',
                masrafTipi: 'normal',
                firmaAdi: 'KARADENIZ SOFRASI',
                vergiNo: '1234567890',
                belgeNo: 'YKF-2024-847521',
                belgeTarihi: '2024-12-09',
                brutTutar: 585.00,
                kdvOrani: 10,
                kdvTutari: 53.18,
                netTutar: 531.82,
                masrafTuru: '770.01',
                ocrGuvenSkoru: 94,
                receiptItems: [
                    { name: '2x Karƒ±≈üƒ±k Izgara', price: '‚Ç∫380.00' },
                    { name: '2x Pilav', price: '‚Ç∫60.00' },
                    { name: '2x ƒ∞√ßecek', price: '‚Ç∫50.00' },
                    { name: '1x K√ºnefe', price: '‚Ç∫95.00' }
                ]
            },
            {
                belgeTuru: 'fatura',
                masrafTipi: 'normal',
                firmaAdi: 'MIGROS Tƒ∞CARET A.≈û.',
                vergiNo: '9876543210',
                belgeNo: 'FTR-2024-158742',
                belgeTarihi: '2024-12-10',
                brutTutar: 1250.00,
                kdvOrani: 20,
                kdvTutari: 208.33,
                netTutar: 1041.67,
                masrafTuru: '770.04',
                ocrGuvenSkoru: 97,
                receiptItems: [
                    { name: 'Ofis Kƒ±rtasiye Malz.', price: '‚Ç∫450.00' },
                    { name: 'Temizlik Malzemeleri', price: '‚Ç∫320.00' },
                    { name: 'Mutfak Gere√ßleri', price: '‚Ç∫280.00' },
                    { name: 'Su ve ƒ∞√ßecek', price: '‚Ç∫200.00' }
                ]
            },
            {
                belgeTuru: 'fis',
                masrafTipi: 'seyahat',
                firmaAdi: 'UBER TURKEY',
                vergiNo: '5554443332',
                belgeNo: 'UBR-2024-984521',
                belgeTarihi: '2024-12-11',
                brutTutar: 245.00,
                kdvOrani: 10,
                kdvTutari: 22.27,
                netTutar: 222.73,
                masrafTuru: '770.02',
                ocrGuvenSkoru: 92,
                receiptItems: [
                    { name: 'Havalimanƒ± Transfer', price: '‚Ç∫185.00' },
                    { name: 'Servis Bedeli', price: '‚Ç∫35.00' },
                    { name: 'Bah≈üi≈ü', price: '‚Ç∫25.00' }
                ]
            },
            {
                belgeTuru: 'fatura',
                masrafTipi: 'normal',
                firmaAdi: 'HILTON ISTANBUL',
                vergiNo: '1112223334',
                belgeNo: 'HTL-2024-005847',
                belgeTarihi: '2024-12-08',
                brutTutar: 3500.00,
                kdvOrani: 10,
                kdvTutari: 318.18,
                netTutar: 3181.82,
                masrafTuru: '770.03',
                ocrGuvenSkoru: 98,
                receiptItems: [
                    { name: '2 Gece Konaklama', price: '‚Ç∫3,000.00' },
                    { name: 'Kahvaltƒ± Dahil', price: '‚Ç∫0.00' },
                    { name: 'Otopark √úcreti', price: '‚Ç∫200.00' },
                    { name: 'Minibar', price: '‚Ç∫300.00' }
                ]
            },
            {
                belgeTuru: 'fatura',
                masrafTipi: 'normal',
                firmaAdi: 'AMAZON WEB SERVICES',
                vergiNo: '7778889990',
                belgeNo: 'AWS-2024-INV-45821',
                belgeTarihi: '2024-12-01',
                brutTutar: 8500.00,
                kdvOrani: 20,
                kdvTutari: 1416.67,
                netTutar: 7083.33,
                masrafTuru: '740.01',
                ocrGuvenSkoru: 99,
                receiptItems: [
                    { name: 'EC2 Instance', price: '‚Ç∫4,500.00' },
                    { name: 'S3 Storage', price: '‚Ç∫1,200.00' },
                    { name: 'RDS Database', price: '‚Ç∫2,000.00' },
                    { name: 'Data Transfer', price: '‚Ç∫800.00' }
                ]
            }
        ];

        // Aktif OCR verisi (deƒüi≈ütirilebilir)
        let currentOCRIndex = 0;
        let ocrData = sampleOCRDatasets[currentOCRIndex];

        // OCR ile form alanlarƒ±nƒ± otomatik doldur
        function fillFormFromOCR() {
            // 1. Belge T√ºr√º ve Masraf Tipi otomatik doldur
            document.getElementById('belgeTuru').value = ocrData.belgeTuru;
            document.getElementById('masrafTipi').value = ocrData.masrafTipi;

            // 2. Belge Bilgileri otomatik doldur
            document.getElementById('firmaAdi').value = ocrData.firmaAdi;
            document.getElementById('vergiNo').value = ocrData.vergiNo;
            document.getElementById('belgeNo').value = ocrData.belgeNo;
            document.getElementById('belgeTarihi').value = ocrData.belgeTarihi;

            // 3. Tutar Bilgileri otomatik doldur
            document.getElementById('brutTutar').value = ocrData.brutTutar.toFixed(2);
            document.getElementById('kdvOrani').value = ocrData.kdvOrani;
            document.getElementById('kdvTutari').value = ocrData.kdvTutari.toFixed(2);
            document.getElementById('netTutar').value = ocrData.netTutar.toFixed(2);

            // 4. Masraf T√ºr√º / Hesap Kodu otomatik doldur ve Kƒ∞Lƒ∞TLE
            const hesapKoduSelect = document.getElementById('hesapKodu');
            hesapKoduSelect.value = ocrData.masrafTuru;
            hesapKoduSelect.disabled = true;
            hesapKoduSelect.style.backgroundColor = '#e8f5e9';
            hesapKoduSelect.style.border = '2px solid #4CAF50';
            hesapKoduSelect.style.cursor = 'not-allowed';

            // Masraf t√ºr√º alanƒ±na OCR kilidi bilgisi ekle
            addOCRLockIndicator();

            // Summary alanlarƒ±nƒ± g√ºncelle
            document.getElementById('summaryBrut').textContent = ocrData.brutTutar.toFixed(2) + ' TL';
            document.getElementById('summaryKdv').textContent = ocrData.kdvTutari.toFixed(2) + ' TL';
            document.getElementById('summaryNet').textContent = ocrData.netTutar.toFixed(2) + ' TL';
            document.getElementById('summaryTotal').textContent = ocrData.brutTutar.toFixed(2) + ' TL';

            // OCR g√ºven skoru g√ºncelle
            document.getElementById('ocrConfidenceTag').textContent = '%' + ocrData.ocrGuvenSkoru + ' Ba≈üarƒ±lƒ±';
        }

        // OCR kilidi g√∂stergesi ekle
        function addOCRLockIndicator() {
            const hesapKoduGroup = document.getElementById('hesapKodu').closest('.form-group');

            // √ñnceki kilit g√∂stergesini kaldƒ±r
            const existingLock = hesapKoduGroup.querySelector('.ocr-lock-indicator');
            if (existingLock) existingLock.remove();

            // Yeni kilit g√∂stergesi ekle
            const lockIndicator = document.createElement('div');
            lockIndicator.className = 'ocr-lock-indicator';
            lockIndicator.innerHTML = `
                <span style="display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; padding: 6px 12px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 6px; font-size: 12px; color: #2e7d32; border: 1px solid #a5d6a7;">
                    üîí OCR tarafƒ±ndan otomatik belirlendi (Deƒüi≈ütirilemez)
                </span>
            `;
            hesapKoduGroup.appendChild(lockIndicator);
        }

        // Fi≈ü √∂nizleme g√∂rselini g√ºncelle
        function updateReceiptPreview() {
            const receiptSimple = document.getElementById('receiptSimple');

            // Masraf t√ºr√º adƒ±nƒ± al
            const masrafTuruAdi = getMasrafTuruAdi(ocrData.masrafTuru);

            // Fi≈ü i√ßeriƒüini g√ºncelle
            let itemsHtml = '';
            ocrData.receiptItems.forEach(item => {
                itemsHtml += `
                    <div class="receipt-simple-item">
                        <span>${item.name}</span>
                        <span>${item.price}</span>
                    </div>
                `;
            });

            receiptSimple.innerHTML = `
                <div class="receipt-simple-header">
                    <strong class="receipt-simple-company">${ocrData.firmaAdi}</strong>
                    <span class="receipt-simple-sub">${masrafTuruAdi}</span>
                </div>
                <div class="receipt-simple-divider"></div>
                <div class="receipt-simple-info">
                    VKN: ${ocrData.vergiNo}<br>
                    Tarih: ${formatDate(ocrData.belgeTarihi)}<br>
                    Fi≈ü No: ${ocrData.belgeNo}
                </div>
                <div class="receipt-simple-divider"></div>
                <div class="receipt-simple-items">
                    ${itemsHtml}
                </div>
                <div class="receipt-simple-totals">
                    <div class="receipt-simple-item">
                        <span>KDV (%${ocrData.kdvOrani})</span>
                        <span>‚Ç∫${ocrData.kdvTutari.toFixed(2)}</span>
                    </div>
                    <div class="receipt-simple-item total">
                        <strong>TOPLAM</strong>
                        <strong>‚Ç∫${ocrData.brutTutar.toFixed(2)}</strong>
                    </div>
                </div>
                <div class="receipt-simple-footer">
                    * TE≈ûEKK√úRLER *<br>
                    Bu belge mali deƒüer ta≈üƒ±r
                </div>
            `;

            // OCR ba≈üarƒ± b√∂l√ºm√ºndeki √∂nizlemeyi de g√ºncelle
            const extractedPreview = document.querySelector('.ocr-extracted-preview');
            if (extractedPreview) {
                extractedPreview.innerHTML = `
                    <div class="extracted-item">
                        <span class="extracted-label">Firma:</span>
                        <span class="extracted-value">${ocrData.firmaAdi}</span>
                    </div>
                    <div class="extracted-item">
                        <span class="extracted-label">Tarih:</span>
                        <span class="extracted-value">${formatDate(ocrData.belgeTarihi)}</span>
                    </div>
                    <div class="extracted-item">
                        <span class="extracted-label">Tutar:</span>
                        <span class="extracted-value highlight">‚Ç∫${ocrData.brutTutar.toFixed(2)}</span>
                    </div>
                `;
            }
        }

        // Masraf t√ºr√º adƒ±nƒ± getir
        function getMasrafTuruAdi(kod) {
            const masrafTurleri = {
                '770.01': 'Yemek Giderleri',
                '770.02': 'Ula≈üƒ±m Giderleri',
                '770.03': 'Konaklama Giderleri',
                '770.04': 'Ofis Malzemesi',
                '770.05': 'Temsil Aƒüƒ±rlama',
                '770.06': 'Haberle≈üme Giderleri',
                '770.07': 'Ta≈üƒ±t Giderleri',
                '740.01': 'Yazƒ±lƒ±m Giderleri',
                '740.02': 'Donanƒ±m Bakƒ±m',
                '740.03': 'IT Destek Hizmetleri'
            };
            return masrafTurleri[kod] || 'Masraf';
        }

        // Tarih formatla
        function formatDate(dateStr) {
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            return dateStr;
        }

        // Farklƒ± belge y√ºkle butonu
        function retakePhoto() {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('collapsed');
            uploadArea.style.display = 'block';

            // File input'u tetikle
            document.getElementById('fileInput').click();
        }

        // Dosya y√ºkleme i≈üleyicisi
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                // Yeni belge y√ºklendi - rastgele bir OCR verisi se√ß (demo i√ßin)
                currentOCRIndex = (currentOCRIndex + 1) % sampleOCRDatasets.length;
                ocrData = sampleOCRDatasets[currentOCRIndex];

                // OCR i≈ülemini ba≈ülat
                simulateNewOCR(e.target.files[0].name);
            }
        });

        // Yeni OCR i≈ülemi sim√ºlasyonu
        function simulateNewOCR(fileName) {
            const ocrProcessing = document.getElementById('ocrProcessing');
            const ocrSuccess = document.getElementById('ocrSuccess');
            const documentPreviewCard = document.getElementById('documentPreviewCard');
            const uploadArea = document.getElementById('uploadArea');

            // Upload alanƒ±nƒ± gizle
            uploadArea.style.display = 'none';
            uploadArea.classList.add('collapsed');

            // ƒ∞≈üleniyor animasyonunu g√∂ster
            documentPreviewCard.style.display = 'none';
            ocrSuccess.style.display = 'none';
            ocrProcessing.style.display = 'block';

            // Step'leri sƒ±fƒ±rla
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(step => document.getElementById(step).classList.remove('active'));

            let currentStep = 0;

            const stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(stepInterval);

                    setTimeout(() => {
                        ocrProcessing.style.display = 'none';
                        ocrSuccess.style.display = 'block';
                        documentPreviewCard.style.display = 'block';

                        // Fi≈ü √∂nizlemesini g√ºncelle
                        updateReceiptPreview();

                        // Form alanlarƒ±nƒ± doldur
                        fillFormFromOCR();

                        // Ba≈üarƒ± mesajƒ±
                        const masrafTuruAdi = getMasrafTuruAdi(ocrData.masrafTuru);
                        showAlert('success', `Yeni belge okundu: "${ocrData.firmaAdi}" - Masraf t√ºr√º "${masrafTuruAdi}" olarak belirlendi ve kilitlendi.`);
                    }, 500);
                }
            }, 400);
        }

        // OCR i≈ülemi sim√ºlasyonu (Tekrar Oku butonu i√ßin)
        function processOCR() {
            const ocrProcessing = document.getElementById('ocrProcessing');
            const ocrSuccess = document.getElementById('ocrSuccess');
            const documentPreviewCard = document.getElementById('documentPreviewCard');

            // ƒ∞≈üleniyor animasyonunu g√∂ster
            documentPreviewCard.style.display = 'none';
            ocrSuccess.style.display = 'none';
            ocrProcessing.style.display = 'block';

            // Step'leri sƒ±fƒ±rla
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(step => document.getElementById(step).classList.remove('active'));

            let currentStep = 0;

            const stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(stepInterval);

                    // ƒ∞≈ülem tamamlandƒ± - formu doldur
                    setTimeout(() => {
                        ocrProcessing.style.display = 'none';
                        ocrSuccess.style.display = 'block';
                        documentPreviewCard.style.display = 'block';

                        // Form alanlarƒ±nƒ± doldur
                        fillFormFromOCR();

                        // Ba≈üarƒ± mesajƒ±
                        showAlert('success', 'OCR ba≈üarƒ±lƒ±! T√ºm alanlar otomatik olarak dolduruldu. Masraf t√ºr√º g√∂rsele g√∂re belirlendi ve kilitlendi.');
                    }, 500);
                }
            }, 400);
        }

        // Sayfa y√ºklendiƒüinde OCR verilerini otomatik doldur
        document.addEventListener('DOMContentLoaded', function() {
            // Y√∂netici kontrol√ºn√º yap
            checkManagerView();

            // Sayfa y√ºklendiƒüinde OCR verilerini otomatik doldur
            setTimeout(() => {
                fillFormFromOCR();
                updateReceiptPreview();
            }, 500);
        });

        // Show/hide fields based on belge t√ºr√º
        document.getElementById('belgeTuru').addEventListener('change', function() {
            const yurtdisiAlanlari = document.getElementById('yurtdisiAlanlari');
            const tevkifatAlanlari = document.getElementById('tevkifatAlanlari');

            // Yurtdƒ±≈üƒ± alanlarƒ±
            if (this.value === 'yurtdisi') {
                yurtdisiAlanlari.style.display = 'block';
            } else {
                yurtdisiAlanlari.style.display = 'none';
            }

            // Tevkifat alanlarƒ±
            if (this.value === 'tevkifatli') {
                tevkifatAlanlari.style.display = 'block';
            } else {
                tevkifatAlanlari.style.display = 'none';
                document.getElementById('tevkifatOrani').value = '0';
                document.getElementById('tevkifatTutari').value = '';
            }
        });

        // Show/hide Ta≈üƒ±t Gideri alanlarƒ± based on hesap kodu
        document.getElementById('hesapKodu').addEventListener('change', function() {
            const tasitGideriAlanlari = document.getElementById('tasitGideriAlanlari');

            if (this.value === '770.07') {
                tasitGideriAlanlari.style.display = 'block';
                updateTasitGideri();
            } else {
                tasitGideriAlanlari.style.display = 'none';
                document.getElementById('giderKismi').value = '';
                document.getElementById('kkegKismi').value = '';
            }
        });

        // Tevkifat hesaplama fonksiyonu
        function updateTevkifat() {
            const kdvTutari = parseFloat(document.getElementById('kdvTutari').value) || 0;
            const tevkifatOrani = document.getElementById('tevkifatOrani').value;

            if (tevkifatOrani && tevkifatOrani !== '0') {
                const [pay, payda] = tevkifatOrani.split('/').map(Number);
                const tevkifatTutari = kdvTutari * (pay / payda);
                document.getElementById('tevkifatTutari').value = tevkifatTutari.toFixed(2);
            } else {
                document.getElementById('tevkifatTutari').value = '';
            }
        }

        // Ta≈üƒ±t Gideri %70/%30 ayrƒ±mƒ± hesaplama fonksiyonu
        function updateTasitGideri() {
            const netTutar = parseFloat(document.getElementById('netTutar').value) || 0;
            const hesapKodu = document.getElementById('hesapKodu').value;

            if (hesapKodu === '770.07' && netTutar > 0) {
                const giderKismi = netTutar * 0.70;
                const kkegKismi = netTutar * 0.30;

                document.getElementById('giderKismi').value = giderKismi.toFixed(2);
                document.getElementById('kkegKismi').value = kkegKismi.toFixed(2);
            }
        }

        // Override updateAmountSummary to also update tevkifat and tasit gideri
        const originalUpdateAmountSummary = window.updateAmountSummary || function() {};
        window.updateAmountSummary = function() {
            originalUpdateAmountSummary();

            // Tutar alanlarƒ± g√ºncelle
            const brutTutar = parseFloat(document.getElementById('brutTutar').value) || 0;
            const kdvOrani = parseFloat(document.getElementById('kdvOrani').value) || 0;

            const kdvHaricTutar = brutTutar / (1 + kdvOrani / 100);
            const kdvTutari = brutTutar - kdvHaricTutar;

            document.getElementById('kdvTutari').value = kdvTutari.toFixed(2);
            document.getElementById('netTutar').value = kdvHaricTutar.toFixed(2);

            // Summary alanlarƒ± g√ºncelle
            document.getElementById('summaryBrut').textContent = brutTutar.toFixed(2) + ' TL';
            document.getElementById('summaryKdv').textContent = kdvTutari.toFixed(2) + ' TL';
            document.getElementById('summaryNet').textContent = kdvHaricTutar.toFixed(2) + ' TL';
            document.getElementById('summaryTotal').textContent = brutTutar.toFixed(2) + ' TL';

            // Tevkifat g√ºncelle
            if (document.getElementById('belgeTuru').value === 'tevkifatli') {
                updateTevkifat();
            }

            // Ta≈üƒ±t gideri g√ºncelle
            if (document.getElementById('hesapKodu').value === '770.07') {
                updateTasitGideri();
            }

            // Tutar limiti kontrol√º
            checkTutarLimiti(brutTutar);
        };

        // ============================================
        // KURAL SETLERƒ∞ - VALƒ∞DASYON FONKSƒ∞YONLARI
        // ============================================

        // Kural 1: Tutar Limiti Kontrol√º (Deƒüi≈ütirilebilir)
        const TUTAR_LIMITI = 50000; // TL (ayarlanabilir)

        function checkTutarLimiti(tutar) {
            const alertContainer = document.getElementById('alertContainer');
            const existingLimitAlert = document.getElementById('limitAlert');

            if (tutar > TUTAR_LIMITI) {
                if (!existingLimitAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'limitAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">üö´</span>
                        <div>
                            <strong>Tutar Limiti A≈üƒ±ldƒ±!</strong><br>
                            Masraf tutarƒ± belirlenen limit olan <strong>${TUTAR_LIMITI.toLocaleString('tr-TR')} TL</strong>'yi a≈ümaktadƒ±r.
                            Bu masraf otomatik olarak onaylanamaz.
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
            } else if (existingLimitAlert) {
                existingLimitAlert.remove();
            }
        }

        // Kural 2: Kabul Edilmeyen Gider Kalemleri (Deƒüi≈ütirilebilir)
        const REDDEDILEN_GIDER_KALEMLERI = [
            'tekel', 'alkol', 'sigara', 't√ºt√ºn', 'i√ßki', 'bira', '≈üarap', 'rakƒ±',
            'viski', 'votka', 'kumar', 'bahis', 'casino'
        ];

        function checkYasakliGiderKalemi(aciklama) {
            const alertContainer = document.getElementById('alertContainer');
            const existingGiderAlert = document.getElementById('giderAlert');
            const lowercaseAciklama = aciklama.toLowerCase();

            const bulunanYasakli = REDDEDILEN_GIDER_KALEMLERI.find(kalem =>
                lowercaseAciklama.includes(kalem)
            );

            if (bulunanYasakli) {
                if (!existingGiderAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'giderAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">‚õî</span>
                        <div>
                            <strong>Kabul Edilmeyen Gider Kalemi!</strong><br>
                            A√ßƒ±klamada kabul edilmeyen gider kalemi tespit edildi: <strong>"${bulunanYasakli}"</strong><br>
                            <small>Bu t√ºr masraflar ≈üirket politikasƒ± gereƒüi kabul edilmemektedir.</small>
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
                return false;
            } else if (existingGiderAlert) {
                existingGiderAlert.remove();
            }
            return true;
        }

        // A√ßƒ±klama alanƒ± kontrol√º
        document.getElementById('aciklama').addEventListener('input', function() {
            checkYasakliGiderKalemi(this.value);
        });

        // Kural 3: M√ºkerrer Fatura Kontrol√º (Sim√ºlasyon)
        // Ger√ßek uygulamada API √ßaƒürƒ±sƒ± ile kontrol edilecek
        const GECMIS_FATURALAR = [
            { firmaAdi: 'KARADENIZ SOFRASI', belgeNo: 'YKF-2024-847520', belgeTarihi: '2024-12-08' },
            { firmaAdi: 'MIGROS', belgeNo: 'F-2024-001234', belgeTarihi: '2024-12-07' }
        ];

        function checkMukerrerFatura() {
            const firmaAdi = document.getElementById('firmaAdi').value.toUpperCase();
            const belgeNo = document.getElementById('belgeNo').value;
            const belgeTarihi = document.getElementById('belgeTarihi').value;

            const alertContainer = document.getElementById('alertContainer');
            const existingMukerrerAlert = document.getElementById('mukerrerAlert');

            const mukerrer = GECMIS_FATURALAR.find(f =>
                f.firmaAdi.toUpperCase() === firmaAdi &&
                f.belgeNo === belgeNo &&
                f.belgeTarihi === belgeTarihi
            );

            if (mukerrer) {
                if (!existingMukerrerAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'mukerrerAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>
                            <strong>M√ºkerrer Fatura Uyarƒ±sƒ±!</strong><br>
                            Bu fatura daha √∂nce sisteme girilmi≈ü g√∂r√ºn√ºyor.<br>
                            <small>Firma: ${firmaAdi} | Belge No: ${belgeNo} | Tarih: ${belgeTarihi}</small>
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
                return false;
            } else if (existingMukerrerAlert) {
                existingMukerrerAlert.remove();
            }
            return true;
        }

        // Belge alanlarƒ± deƒüi≈ütiƒüinde m√ºkerrer kontrol√º
        ['firmaAdi', 'belgeNo', 'belgeTarihi'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('change', checkMukerrerFatura);
        });

        // Kural 4: ≈ûirket E≈üle≈üme Kontrol√º
        // √áalƒ±≈üanƒ±n bordro ≈üirketi ile fatura ≈üirketi uyumlu olmalƒ±
        const KULLANICI_BORDRO_SIRKETI = 'flo_teknoloji'; // √ñrnek: Login'den gelecek
        const SIRKET_VKN_ESLESMESI = {
            'flo_magazacilik': ['1234567890', '9876543210'],
            'flo_teknoloji': ['1111111111', '2222222222'],
            'turuncu': ['3333333333', '4444444444'],
            'flo_ic_dis': ['5555555555', '6666666666']
        };

        function checkSirketEslesmesi() {
            const secilenSirket = document.getElementById('sirket').value;
            const alertContainer = document.getElementById('alertContainer');
            const existingSirketAlert = document.getElementById('sirketAlert');

            if (secilenSirket !== KULLANICI_BORDRO_SIRKETI) {
                if (!existingSirketAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'sirketAlert';
                    alert.className = 'alert alert-warning';
                    alert.innerHTML = `
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div>
                            <strong>≈ûirket Uyumsuzluƒüu!</strong><br>
                            Bordro ≈üirketiniz ile se√ßilen ≈üirket farklƒ±.
                            Farklƒ± ≈üirket adƒ±na masraf giri≈üi i√ßin gerek√ße belirtmeniz gerekmektedir.
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
            } else if (existingSirketAlert) {
                existingSirketAlert.remove();
            }
        }

        document.getElementById('sirket').addEventListener('change', checkSirketEslesmesi);

        // Form submit validasyonu
        const originalSubmitMasrafForm = window.submitMasrafForm || function() {};
        window.submitMasrafForm = function() {
            const brutTutar = parseFloat(document.getElementById('brutTutar').value) || 0;
            const aciklama = document.getElementById('aciklama').value;
            const belgeTuru = document.getElementById('belgeTuru').value;

            // Disabled select'in deƒüerini al (OCR tarafƒ±ndan kilitlenmi≈ü olabilir)
            const hesapKoduSelect = document.getElementById('hesapKodu');
            const hesapKodu = hesapKoduSelect.value;

            // Zorunlu alan kontrolleri
            if (!belgeTuru) {
                showValidationAlert('L√ºtfen belge t√ºr√ºn√º se√ßiniz.', 'error');
                return;
            }
            if (!hesapKodu) {
                showValidationAlert('L√ºtfen masraf t√ºr√º / hesap kodunu se√ßiniz.', 'error');
                return;
            }
            if (!aciklama.trim()) {
                showValidationAlert('Masraf a√ßƒ±klamasƒ± zorunludur.', 'error');
                return;
            }
            if (brutTutar <= 0) {
                showValidationAlert('Ge√ßerli bir tutar giriniz.', 'error');
                return;
            }

            // Kural seti kontrolleri
            if (brutTutar > TUTAR_LIMITI) {
                showValidationAlert('Tutar limiti a≈üƒ±ldƒ±ƒüƒ± i√ßin bu masraf g√∂nderilemez.', 'error');
                return;
            }

            if (!checkYasakliGiderKalemi(aciklama)) {
                showValidationAlert('Kabul edilmeyen gider kalemi i√ßeren masraf g√∂nderilemez.', 'error');
                return;
            }

            if (!checkMukerrerFatura()) {
                showValidationAlert('M√ºkerrer fatura tespit edildi. L√ºtfen kontrol ediniz.', 'error');
                return;
            }

            // T√ºm kontroller ge√ßti, formu g√∂nder
            showAlert('success', 'Masraf talebiniz ba≈üarƒ±yla onaya g√∂nderildi!');
            setTimeout(() => {
                window.location.href = 'masraf-listesi.html';
            }, 2000);
        };

        // Alert g√∂sterme fonksiyonu (main.js ile uyumlu)
        // Not: main.js'deki showAlert(type, message) fonksiyonunu kullanƒ±yoruz
        // Bu sayfaya √∂zel validasyon alertleri i√ßin ayrƒ± bir fonksiyon tanƒ±mlƒ±yoruz
        function showValidationAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span class="alert-icon">${type === 'error' ? '‚ùå' : '‚úÖ'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 18px;">√ó</button>
            `;
            alertContainer.prepend(alert);

            if (type === 'success') {
                setTimeout(() => alert.remove(), 5000);
            }
        }

        // Y√∂netici g√∂r√ºn√ºm√º kontrol√º
        function checkManagerView() {
            const urlParams = new URLSearchParams(window.location.search);
            const isManagerRole = urlParams.get('role') === 'manager';

            if (isManagerRole) {
                document.getElementById('sidebarEmployee').style.display = 'none';
                document.getElementById('sidebarManager').style.display = 'block';
            }
        }

    </script>
</body>
</html>
