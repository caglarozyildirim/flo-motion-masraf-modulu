<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masraf Formu - FLOConnect</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* User Badge - Standardized */
        .user-badge {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-burgundy));
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
        <div class="logo">FLO<span style="font-weight: 300;">Connect</span></div>
        <div class="header-actions">
            <div class="notification-wrapper">
                <button class="notification-btn" onclick="toggleNotifications()">
                    ğŸ”” Bildirimler
                    <span class="notification-badge">3</span>
                </button>
                <div class="notification-dropdown" id="notificationDropdown">
                    <div class="notification-header">
                        <h3>Bildirimler</h3>
                        <div class="notification-header-actions">
                            <button class="mark-all-read" onclick="markAllNotificationsRead()">TÃ¼mÃ¼nÃ¼ okundu iÅŸaretle</button>
                        </div>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                    <div class="notification-footer">
                        <a href="bildirimler.html">TÃ¼m bildirimleri gÃ¶rÃ¼ntÃ¼le</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar - Employee View -->
        <aside class="sidebar" id="sidebarEmployee">
            <button class="sidebar-close" onclick="closeMobileMenu()">âœ•</button>
            <div class="user-profile">
                <div class="user-avatar">BT</div>
                <div class="user-name">Berat TanrÄ±verdi</div>
                <div class="user-title">KÄ±demli Uzman</div>
                <div class="user-role">ÃœrÃ¼n TasarÄ±m/UX MÃ¼d.</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="calisan-anasayfa.html" class="nav-link">
                        <span class="nav-icon">ğŸ </span>
                        Anasayfa
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-formu.html" class="nav-link active">
                        <span class="nav-icon">ğŸ§¾</span>
                        Yeni Masraf GiriÅŸi
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html" class="nav-link">
                        <span class="nav-icon">ğŸ“‹</span>
                        Masraf Taleplerim
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="window.location.href='index.html'">
                ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
            </button>
        </aside>

        <!-- Sidebar - Manager View -->
        <aside class="sidebar" id="sidebarManager" style="display: none;">
            <button class="sidebar-close" onclick="closeMobileMenu()">âœ•</button>
            <div class="user-profile">
                <div class="user-avatar">MY</div>
                <div class="user-name">Mehmet YÄ±lmaz</div>
                <div class="user-title">Dijital ÃœrÃ¼nler DirektÃ¶rÃ¼</div>
                <div class="user-badge">4. Derece Onay Yetkisi</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="yonetici-anasayfa.html" class="nav-link">
                        <span class="nav-icon">ğŸ </span>
                        Anasayfa
                    </a>
                </li>
                <li class="nav-item">
                    <a href="onay-listesi.html" class="nav-link">
                        <span class="nav-icon">â³</span>
                        Onay Bekleyenler
                        <span style="background: var(--warning-red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: auto;">7</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html?view=all" class="nav-link">
                        <span class="nav-icon">ğŸ“‹</span>
                        MasraflarÄ±m
                        <span style="background: var(--primary-orange); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: auto;">5</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html?view=team" class="nav-link">
                        <span class="nav-icon">ğŸ‘¥</span>
                        Ekip MasraflarÄ±
                        <span style="background: var(--text-secondary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: auto;">23</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-formu.html?role=manager" class="nav-link active">
                        <span class="nav-icon">ğŸ§¾</span>
                        Masraf GiriÅŸi
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="window.location.href='index.html'">
                ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="calisan-anasayfa.html">Anasayfa</a>
                <span>â€º</span>
                <span>Yeni Masraf GiriÅŸi</span>
            </div>

            <h1 class="page-title">Yeni Masraf GiriÅŸi</h1>

            <!-- Warning Alert -->
            <div class="alert alert-warning">
                <span class="alert-icon">âš ï¸</span>
                <div>
                    <strong>Ã–nemli:</strong> FiÅŸ veya fatura gÃ¶rselini yÃ¼kleyiniz. OCR sistemi belgenizi otomatik olarak okuyacaktÄ±r.
                    Okunan bilgileri kontrol edip onaylamanÄ±z gerekmektedir.
                </div>
            </div>

            <!-- Demo Test Panel - Yeni Ã–zellikler -->
            <div class="alert alert-info" style="margin-bottom: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196F3;">
                <span class="alert-icon" style="font-size: 24px;">ğŸ†•</span>
                <div style="flex: 1;">
                    <strong style="color: #1565C0; font-size: 15px;">YENÄ° Ã–ZELLÄ°KLER - Demo Test Butonu</strong>
                    <ul style="margin: 8px 0 12px 0; padding-left: 20px; font-size: 13px; color: #333;">
                        <li><b>Ã‡oklu fiÅŸ giriÅŸi:</b> Tek talepte birden fazla belge (Migros Ã¶rneÄŸi: yemek + kÄ±rtasiye + temizlik)</li>
                        <li><b>SatÄ±r bazlÄ± gider detayÄ±:</b> Her kalem iÃ§in tutar ve KDV ayrÄ± gÃ¶sterilir</li>
                        <li><b>Masraf harici satÄ±r Ã§Ä±karma:</b> OCR'dan okunan gereksiz satÄ±rlarÄ± Ã§Ä±karabilirsiniz</li>
                        <li><b>Ã‡oklu KDV oranÄ±:</b> AynÄ± fiÅŸte %10 ve %20 KDV'li Ã¼rÃ¼nler olabilir</li>
                    </ul>
                    <button type="button" onclick="demoKarmaFisYukle()" class="btn-primary" style="background: #2196F3; border-color: #1976D2; padding: 10px 24px; font-size: 14px;">
                        ğŸ§ª Demo: Karma FiÅŸ YÃ¼kle (Migros Ã–rneÄŸi)
                    </button>
                    <span style="font-size: 11px; color: #666; margin-left: 12px;">TÄ±klayarak satÄ±r bazlÄ± gider detaylarÄ±nÄ± test edin</span>
                </div>
            </div>

            <div class="form-container">
                <!-- Section 1: Belge YÃ¼kleme -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">1</span>
                        Belge YÃ¼kleme (OCR) - Ã‡oklu FiÅŸ DesteÄŸi
                    </h2>

                    <div class="alert alert-info" style="margin-bottom: 20px;">
                        <span class="alert-icon">ğŸ’¡</span>
                        <div>
                            <strong>Ã‡oklu FiÅŸ GiriÅŸi:</strong> Tek bir masraf talebinde birden fazla fiÅŸ/fatura yÃ¼kleyebilirsiniz.
                            Ã–rneÄŸin Migros'tan aldÄ±ÄŸÄ±nÄ±z yemek, kÄ±rtasiye ve temizlik malzemelerini aynÄ± talepte toplayabilirsiniz.
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Belge TÃ¼rÃ¼</label>
                            <select class="form-select" id="belgeTuru">
                                <option value="">SeÃ§iniz...</option>
                                <option value="fatura">Fatura</option>
                                <option value="tevkifatli">TevkifatlÄ± Fatura</option>
                                <option value="fis">Yazar Kasa / Perakende SatÄ±ÅŸ FiÅŸi</option>
                                <option value="yurtdisi">YurtdÄ±ÅŸÄ± FaturasÄ±</option>
                                <option value="dekont">Dekont / HarÃ§ / Makbuz</option>
                                <option value="su">Su FaturasÄ±</option>
                                <option value="gider_pusulasi">Gider PusulasÄ±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Masraf Tipi</label>
                            <select class="form-select" id="masrafTipi">
                                <option value="">SeÃ§iniz...</option>
                                <option value="normal">Normal Masraf</option>
                                <option value="seyahat">Seyahat MasrafÄ±</option>
                                <option value="kredi_karti">Kredi KartÄ± MasrafÄ±</option>
                                <option value="kiralama">Kiralama FaturasÄ±</option>
                            </select>
                        </div>
                    </div>

                    <!-- Belge GÃ¶rseli Preview -->
                    <div class="document-preview-card" id="documentPreviewCard">
                        <h3 class="preview-title">ğŸ–¼ï¸ Belge GÃ¶rseli (OCR ile Okundu)</h3>
                        <div class="document-preview-container">
                            <!-- SimÃ¼le edilmiÅŸ fiÅŸ gÃ¶rseli -->
                            <div class="receipt-simple" id="receiptSimple">
                                <div class="receipt-simple-header">
                                    <strong class="receipt-simple-company">KARADENIZ SOFRASI</strong>
                                    <span class="receipt-simple-sub">Restoran & Lokanta</span>
                                </div>
                                <div class="receipt-simple-divider"></div>
                                <div class="receipt-simple-info">
                                    VKN: 1234567890<br>
                                    Tarih: 09.12.2024 13:45<br>
                                    FiÅŸ No: YKF-2024-847521
                                </div>
                                <div class="receipt-simple-divider"></div>
                                <div class="receipt-simple-items">
                                    <div class="receipt-simple-item">
                                        <span>2x KarÄ±ÅŸÄ±k Izgara</span>
                                        <span>â‚º380.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>2x Pilav</span>
                                        <span>â‚º60.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>2x Ä°Ã§ecek</span>
                                        <span>â‚º50.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>1x KÃ¼nefe</span>
                                        <span>â‚º95.00</span>
                                    </div>
                                </div>
                                <div class="receipt-simple-totals">
                                    <div class="receipt-simple-item">
                                        <span>KDV (%10)</span>
                                        <span>â‚º53.18</span>
                                    </div>
                                    <div class="receipt-simple-item total">
                                        <strong>TOPLAM</strong>
                                        <strong>â‚º585.00</strong>
                                    </div>
                                </div>
                                <div class="receipt-simple-footer">
                                    * TEÅEKKÃœRLER *<br>
                                    Bu belge mali deÄŸer taÅŸÄ±r
                                </div>
                            </div>

                            <div class="ocr-confidence-badge">
                                <span>ğŸ¤– OCR GÃ¼ven Skoru:</span>
                                <span class="confidence-tag" id="ocrConfidenceTag">%94 BaÅŸarÄ±lÄ±</span>
                            </div>
                        </div>

                        <div class="document-actions">
                            <button class="btn-action-primary" onclick="processOCR()">
                                âœ¨ OCR ile Tekrar Oku
                            </button>
                        </div>
                    </div>

                    <!-- OCR Processing Animation -->
                    <div class="ocr-processing" id="ocrProcessing" style="display: none;">
                        <div class="processing-animation">
                            <div class="scan-line"></div>
                            <div class="processing-icon">ğŸ”</div>
                        </div>
                        <div class="processing-text">Belge Okunuyor...</div>
                        <div class="processing-steps">
                            <div class="step-item" id="step1">
                                <span class="step-dot"></span>
                                <span>GÃ¶rÃ¼ntÃ¼ analiz ediliyor...</span>
                            </div>
                            <div class="step-item" id="step2">
                                <span class="step-dot"></span>
                                <span>Metin tanÄ±nÄ±yor...</span>
                            </div>
                            <div class="step-item" id="step3">
                                <span class="step-dot"></span>
                                <span>Veriler Ã§Ä±karÄ±lÄ±yor...</span>
                            </div>
                            <div class="step-item" id="step4">
                                <span class="step-dot"></span>
                                <span>Form dolduruluyor...</span>
                            </div>
                        </div>
                    </div>

                    <!-- OCR Success Result -->
                    <div class="ocr-success" id="ocrSuccess" style="display: none;">
                        <div class="success-header">
                            <div class="success-icon">âœ…</div>
                            <div class="success-text">
                                <h3>OCR BaÅŸarÄ±lÄ±!</h3>
                                <p>Belge bilgileri otomatik olarak dolduruldu</p>
                            </div>
                            <div class="confidence-score">
                                <div class="score-circle">
                                    <span class="score-value">94%</span>
                                </div>
                                <span class="score-label">DoÄŸruluk</span>
                            </div>
                        </div>
                        <div class="ocr-extracted-preview">
                            <div class="extracted-item">
                                <span class="extracted-label">Firma:</span>
                                <span class="extracted-value">KARADENIZ SOFRASI</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Tarih:</span>
                                <span class="extracted-value">09.12.2024</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Tutar:</span>
                                <span class="extracted-value highlight">â‚º585.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Area (Yeni Belge YÃ¼kleme) -->
                    <div class="file-upload-area collapsed" id="uploadArea">
                        <input type="file" id="fileInput" accept="image/*,.pdf" multiple>
                        <div class="upload-icon">ğŸ“¤</div>
                        <div class="upload-text">FarklÄ± Bir Belge YÃ¼kle</div>
                        <div class="upload-hint">veya tÄ±klayarak dosya seÃ§in (JPG, PNG, PDF - Max 10MB)</div>
                    </div>

                    <!-- Uploaded Files List -->
                    <div class="uploaded-files" id="uploadedFiles"></div>

                    <!-- YÃ¼klenen Belgeler Listesi (Ã‡oklu) -->
                    <div id="belgelerListesiContainer" style="display: none; margin-top: 20px;">
                        <h4 style="font-size: 15px; color: var(--primary-orange); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            ğŸ“‘ YÃ¼klenen Belgeler <span id="belgeSayisi" class="status-badge status-waiting">0 Belge</span>
                        </h4>
                        <div id="belgelerListesi" class="belgeler-listesi"></div>
                        <button type="button" class="btn-outline" onclick="yeniBelgeEkle()" style="margin-top: 12px; padding: 10px 20px;">
                            â• Yeni Belge Ekle
                        </button>
                    </div>
                </div>

                <!-- Section 2: Okunan Gider SatÄ±rlarÄ± (YENÄ°) -->
                <div class="form-section" id="giderSatirlariSection" style="display: none;">
                    <h2 class="section-title">
                        <span class="section-number">2</span>
                        Okunan Gider SatÄ±rlarÄ±
                    </h2>

                    <div class="alert alert-info" style="margin-bottom: 16px;">
                        <span class="alert-icon">ğŸ“</span>
                        <div>
                            <strong>Gider SatÄ±rÄ± DÃ¼zenleme:</strong> OCR tarafÄ±ndan okunan gider satÄ±rlarÄ±nÄ± gÃ¶rebilir,
                            masrafa konu olmayan satÄ±rlarÄ± Ã§Ä±karabilirsiniz. Her satÄ±rÄ±n KDV oranÄ± farklÄ± olabilir.
                        </div>
                    </div>

                    <div class="gider-satirlari-tablosu">
                        <table class="data-table" id="giderSatirlariTable">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">
                                        <input type="checkbox" id="selectAllRows" onchange="toggleAllRows(this)">
                                    </th>
                                    <th>Gider Kalemi</th>
                                    <th>AÃ§Ä±klama</th>
                                    <th>Hesap Kodu</th>
                                    <th style="text-align: right;">Net Tutar</th>
                                    <th style="text-align: center;">KDV %</th>
                                    <th style="text-align: right;">KDV TutarÄ±</th>
                                    <th style="text-align: right;">BrÃ¼t Tutar</th>
                                    <th style="width: 80px;">Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="giderSatirlariBody">
                                <!-- JavaScript ile doldurulacak -->
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa; font-weight: 600;">
                                    <td colspan="4" style="text-align: right;">TOPLAM:</td>
                                    <td style="text-align: right;" id="toplamNetTutar">â‚º0.00</td>
                                    <td style="text-align: center;">-</td>
                                    <td style="text-align: right;" id="toplamKdvTutar">â‚º0.00</td>
                                    <td style="text-align: right; color: var(--primary-orange);" id="toplamBrutTutar">â‚º0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button type="button" class="btn-secondary" onclick="secilenSatirlariCikar()" id="btnSecilenCikar" disabled>
                            ğŸ—‘ï¸ SeÃ§ilenleri Ã‡Ä±kar
                        </button>
                        <button type="button" class="btn-outline" onclick="yeniGiderSatiriEkle()">
                            â• Manuel SatÄ±r Ekle
                        </button>
                    </div>

                    <!-- KDV Ã–zeti -->
                    <div class="kdv-ozeti" style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">ğŸ“Š KDV OranlarÄ±na GÃ¶re DaÄŸÄ±lÄ±m</h4>
                        <div id="kdvDagilimi" style="display: flex; gap: 16px; flex-wrap: wrap;"></div>
                    </div>
                </div>

                <!-- Section 3: Belge Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">3</span>
                        Belge Bilgileri
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Belge/Fatura No</label>
                            <input type="text" class="form-input" id="belgeNo" placeholder="Otomatik okunacak">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Belge Tarihi</label>
                            <input type="date" class="form-input" id="belgeTarihi">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Firma/TedarikÃ§i AdÄ±</label>
                            <input type="text" class="form-input" id="firmaAdi" placeholder="Otomatik okunacak">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vergi Kimlik No</label>
                            <input type="text" class="form-input" id="vergiNo" placeholder="Otomatik okunacak">
                        </div>
                    </div>

                    <!-- Cari Durumu (Sadece Fatura iÃ§in gÃ¶rÃ¼nÃ¼r) -->
                    <div class="form-row" id="cariDurumuRow" style="display: none;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Cari Durumu</label>
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <span class="status-badge status-approved" id="cariDurum">Cari Mevcut</span>
                                <span style="font-size: 13px; color: var(--text-secondary);" id="cariKoduText">SAP Cari Kodu: 320.01.001</span>
                            </div>
                            <div id="cariEksikUyari" style="display: none; margin-top: 8px;">
                                <div class="alert alert-warning" style="margin-bottom: 0;">
                                    <span class="alert-icon">âš ï¸</span>
                                    <div>
                                        <strong>Cari KaydÄ± BulunamadÄ±!</strong><br>
                                        <small>Bu tedarikÃ§i iÃ§in cari kaydÄ± mevcut deÄŸil. Masraf talebi "Cari Gerekli" statÃ¼sÃ¼nde iÅŸleme alÄ±nacaktÄ±r.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Tutar Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">4</span>
                        Tutar Bilgileri
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">BrÃ¼t Tutar (TL)</label>
                            <input type="number" class="form-input" id="brutTutar" step="0.01" placeholder="0.00" oninput="updateAmountSummary()">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">KDV OranÄ± (%)</label>
                            <select class="form-select" id="kdvOrani" onchange="updateAmountSummary()">
                                <option value="0">%0</option>
                                <option value="1">%1</option>
                                <option value="10">%10</option>
                                <option value="20" selected>%20</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">KDV TutarÄ± (TL)</label>
                            <input type="number" class="form-input" id="kdvTutari" step="0.01" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">KDV HariÃ§ Tutar (TL)</label>
                            <input type="number" class="form-input" id="netTutar" step="0.01" readonly style="background: #f5f5f5;">
                        </div>
                    </div>

                    <!-- Tevkifat AlanlarÄ± (TevkifatlÄ± Fatura iÃ§in) -->
                    <div id="tevkifatAlanlari" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Tevkifat OranÄ±</label>
                                <select class="form-select" id="tevkifatOrani" onchange="updateTevkifat()">
                                    <option value="0">Tevkifat Yok</option>
                                    <option value="2/10">2/10 - YapÄ±m Ä°ÅŸleri</option>
                                    <option value="4/10">4/10 - Temizlik Hizmetleri</option>
                                    <option value="5/10">5/10 - Makine BakÄ±m</option>
                                    <option value="7/10">7/10 - EtÃ¼t, Plan Proje</option>
                                    <option value="9/10">9/10 - YapÄ± Denetim</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tevkifat TutarÄ± (TL)</label>
                                <input type="number" class="form-input" id="tevkifatTutari" step="0.01" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <span class="alert-icon">â„¹ï¸</span>
                            <span>TevkifatlÄ± faturalarda KDV'nin bir kÄ±smÄ± satÄ±cÄ± tarafÄ±ndan beyan edilir.</span>
                        </div>
                    </div>

                    <!-- TaÅŸÄ±t Gideri AyrÄ±mÄ± (%70 Gider / %30 KKEG) -->
                    <div id="tasitGideriAlanlari" style="display: none;">
                        <div class="alert alert-warning">
                            <span class="alert-icon">âš ï¸</span>
                            <div>
                                <strong>TaÅŸÄ±t Gideri AyrÄ±mÄ±:</strong> Bu masraf taÅŸÄ±t gideri olarak iÅŸaretlendi.<br>
                                <small>Tutar otomatik olarak %70 Gider ve %30 KKEG olarak ayrÄ±lacaktÄ±r.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Gider KÄ±smÄ± (%70)</label>
                                <input type="number" class="form-input" id="giderKismi" step="0.01" readonly style="background: #E8F5E9;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">KKEG KÄ±smÄ± (%30)</label>
                                <input type="number" class="form-input" id="kkegKismi" step="0.01" readonly style="background: #FFF3E0;">
                            </div>
                        </div>
                    </div>

                    <!-- YurtdÄ±ÅŸÄ± Masraf AlanlarÄ± (gizli) -->
                    <div id="yurtdisiAlanlari" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">DÃ¶viz TutarÄ±</label>
                                <input type="number" class="form-input" id="yurtdisiTutar" step="0.01" oninput="convertCurrency()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Para Birimi</label>
                                <select class="form-select" id="paraBirimi">
                                    <option value="USD">USD - Amerikan DolarÄ±</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - Ä°ngiliz Sterlini</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kur OranÄ±</label>
                                <input type="number" class="form-input" id="kurOrani" step="0.0001" oninput="convertCurrency()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TL KarÅŸÄ±lÄ±ÄŸÄ±</label>
                                <input type="number" class="form-input" id="tlKarsiligi" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                    </div>

                    <!-- Amount Summary -->
                    <div class="amount-summary">
                        <div class="amount-row">
                            <span>BrÃ¼t Tutar:</span>
                            <span id="summaryBrut">0.00 TL</span>
                        </div>
                        <div class="amount-row">
                            <span>KDV TutarÄ±:</span>
                            <span id="summaryKdv">0.00 TL</span>
                        </div>
                        <div class="amount-row">
                            <span>KDV HariÃ§ Tutar:</span>
                            <span id="summaryNet">0.00 TL</span>
                        </div>
                        <div class="amount-row total">
                            <span>Toplam Masraf:</span>
                            <span id="summaryTotal">0.00 TL</span>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Masraf DetaylarÄ± -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">5</span>
                        Masraf DetaylarÄ±
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Masraf Merkezi</label>
                            <input type="text" class="form-input" id="masrafMerkezi" value="50G1022 - Dijital ÃœrÃ¼nler" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Masraf TÃ¼rÃ¼ / Hesap Kodu</label>
                            <select class="form-select" id="hesapKodu">
                                <option value="">SeÃ§iniz...</option>
                                <optgroup label="Genel YÃ¶netim Giderleri - Merkez (770)">
                                    <option value="770.01">770.01 - Yemek Giderleri</option>
                                    <option value="770.02">770.02 - UlaÅŸÄ±m Giderleri</option>
                                    <option value="770.03">770.03 - Konaklama Giderleri</option>
                                    <option value="770.04">770.04 - Ofis Malzemesi</option>
                                    <option value="770.05">770.05 - Temsil AÄŸÄ±rlama</option>
                                    <option value="770.06">770.06 - HaberleÅŸme Giderleri</option>
                                    <option value="770.07">770.07 - TaÅŸÄ±t Giderleri</option>
                                </optgroup>
                                <optgroup label="Pazarlama SatÄ±ÅŸ DaÄŸÄ±tÄ±m - MaÄŸazalar (760)">
                                    <option value="760.01">760.01 - MaÄŸaza Giderleri</option>
                                    <option value="760.02">760.02 - TanÄ±tÄ±m Giderleri</option>
                                    <option value="760.03">760.03 - SatÄ±ÅŸ Promosyon</option>
                                </optgroup>
                                <optgroup label="Ar-Ge / TasarÄ±m Merkezi (750)">
                                    <option value="750.01">750.01 - Proje Giderleri</option>
                                    <option value="750.02">750.02 - AraÅŸtÄ±rma Giderleri</option>
                                    <option value="750.03">750.03 - Test ve GeliÅŸtirme</option>
                                </optgroup>
                                <optgroup label="Teknoloji Teknik Destek (740)">
                                    <option value="740.01">740.01 - YazÄ±lÄ±m Giderleri</option>
                                    <option value="740.02">740.02 - DonanÄ±m BakÄ±m</option>
                                    <option value="740.03">740.03 - IT Destek Hizmetleri</option>
                                </optgroup>
                                <optgroup label="Fabrika Giderleri (730)">
                                    <option value="730.01">730.01 - Ãœretim Giderleri</option>
                                    <option value="730.02">730.02 - Hammadde Giderleri</option>
                                    <option value="730.03">730.03 - BakÄ±m OnarÄ±m</option>
                                </optgroup>
                                <optgroup label="ÅirketlerarasÄ± YansÄ±tmalar (198)">
                                    <option value="198.01">198.01 - FLO MaÄŸazacÄ±lÄ±k YansÄ±tma</option>
                                    <option value="198.02">198.02 - FLO Teknoloji YansÄ±tma</option>
                                    <option value="198.03">198.03 - Turuncu YansÄ±tma</option>
                                </optgroup>
                                <optgroup label="Kiralama Giderleri (632)">
                                    <option value="632.04.01">632.04.01 - MaÄŸaza Asgari Kira</option>
                                    <option value="632.04.02">632.04.02 - Ortak YÃ¶netim Gideri</option>
                                    <option value="632.04.03">632.04.03 - Ciro Kira Gideri</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Proje Kodu (Opsiyonel)</label>
                            <select class="form-select" id="projeKodu">
                                <option value="">Proje seÃ§iniz (opsiyonel)...</option>
                                <option value="PRJ001">PRJ001 - E-Ticaret Yenileme</option>
                                <option value="PRJ002">PRJ002 - Mobil Uygulama v2</option>
                                <option value="PRJ003">PRJ003 - CRM Entegrasyonu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Åirket</label>
                            <select class="form-select" id="sirket">
                                <option value="flo_magazacilik">FLO MaÄŸazacÄ±lÄ±k</option>
                                <option value="turuncu">Turuncu AyakkabÄ±</option>
                                <option value="flo_teknoloji">FLO Teknoloji</option>
                                <option value="flo_ic_dis">FLO Ä°Ã§ DÄ±ÅŸ Ticaret</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label required">Masraf AÃ§Ä±klamasÄ±</label>
                            <textarea class="form-textarea" id="aciklama" placeholder="MasrafÄ±n ne iÃ§in yapÄ±ldÄ±ÄŸÄ±nÄ± detaylÄ± aÃ§Ä±klayÄ±nÄ±z..." required></textarea>
                            <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                                * Bu aÃ§Ä±klama hesap eÅŸleÅŸtirmesinde kullanÄ±lacaktÄ±r. LÃ¼tfen detaylÄ± yazÄ±nÄ±z.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Onay Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">6</span>
                        Onay AkÄ±ÅŸÄ± Bilgileri
                    </h2>

                    <div class="alert alert-info">
                        <span class="alert-icon">â„¹ï¸</span>
                        <div>
                            Masraf tutarÄ±nÄ±za gÃ¶re onay akÄ±ÅŸÄ± otomatik belirlenecektir.
                            <strong>7.500 TL</strong> altÄ± masraflar sadece birim mÃ¼dÃ¼rÃ¼ onayÄ± ile tamamlanÄ±r.
                        </div>
                    </div>

                    <!-- Approval Timeline Preview -->
                    <div class="approval-timeline" id="normalOnayAkisi">
                        <div class="approval-step completed">
                            <div class="step-circle">âœ“</div>
                            <div class="step-label">Talep OluÅŸtur</div>
                            <div class="step-person">Berat TanrÄ±verdi</div>
                        </div>
                        <div class="approval-step current">
                            <div class="step-circle">1</div>
                            <div class="step-label">YÃ¶netici OnayÄ±</div>
                            <div class="step-person">Mehmet YÄ±lmaz (5.Derece)</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Muhasebe OnayÄ±</div>
                            <div class="step-person">Muhasebe Havuzu</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">SAP AktarÄ±m</div>
                            <div class="step-person">Otomatik</div>
                        </div>
                    </div>

                    <!-- MaÄŸaza MasraflarÄ± iÃ§in ATF Kargo Takip AkÄ±ÅŸÄ± -->
                    <div class="approval-timeline" id="magazaOnayAkisi" style="display: none;">
                        <div class="approval-step completed">
                            <div class="step-circle">âœ“</div>
                            <div class="step-label">Talep OluÅŸtur</div>
                            <div class="step-person">MaÄŸaza Personeli</div>
                        </div>
                        <div class="approval-step current">
                            <div class="step-circle">1</div>
                            <div class="step-label">YÃ¶netici OnayÄ±</div>
                            <div class="step-person">BÃ¶lge MÃ¼dÃ¼rÃ¼</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Kargo Teslim</div>
                            <div class="step-person">ATF NumarasÄ± Gir</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">Muhasebe OnayÄ±</div>
                            <div class="step-person">Perakende Muhasebe</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">4</div>
                            <div class="step-label">SAP AktarÄ±m</div>
                            <div class="step-person">Otomatik</div>
                        </div>
                    </div>

                    <!-- ATF Kargo Bilgileri (MaÄŸaza masraflarÄ± iÃ§in) -->
                    <div id="atfKargoAlani" style="display: none; margin-top: 20px;">
                        <div class="alert alert-warning">
                            <span class="alert-icon">ğŸ“¦</span>
                            <div>
                                <strong>MaÄŸaza MasrafÄ± - Kargo Takip ZorunluluÄŸu</strong><br>
                                <small>MaÄŸaza masraflarÄ± onaylandÄ±ktan sonra, belgeler kargo ile gÃ¶nderilmeli ve ATF numarasÄ± girilmelidir.
                                Muhasebe onayÄ±, kargo teslim edildiÄŸinde baÅŸlayacaktÄ±r.</small>
                            </div>
                        </div>
                        <div class="form-row" style="margin-top: 16px;">
                            <div class="form-group">
                                <label class="form-label">ATF NumarasÄ± (Kargo Takip)</label>
                                <input type="text" class="form-input" id="atfNumarasi" placeholder="Kargo ÅŸirketi ATF numarasÄ±" disabled>
                                <small style="color: var(--text-secondary); font-size: 11px;">* YÃ¶netici onayÄ±ndan sonra aktif olacaktÄ±r</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kargo Åirketi</label>
                                <select class="form-select" id="kargoSirketi" disabled>
                                    <option value="">SeÃ§iniz...</option>
                                    <option value="yurtici">YurtiÃ§i Kargo</option>
                                    <option value="aras">Aras Kargo</option>
                                    <option value="mng">MNG Kargo</option>
                                    <option value="ptt">PTT Kargo</option>
                                    <option value="ups">UPS</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kargo Durumu</label>
                                <div id="kargoDurumu" style="padding: 10px; background: #f5f5f5; border-radius: 6px;">
                                    <span class="status-badge status-draft">Bekleniyor</span>
                                    <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">YÃ¶netici onayÄ± bekleniyor</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tahmini Teslim</label>
                                <input type="date" class="form-input" id="tahminTeslim" disabled>
                            </div>
                        </div>
                    </div>

                    <!-- MaÄŸaza MasrafÄ± Checkbox -->
                    <div style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="magazaMasrafiCheckbox" onchange="toggleMagazaMasrafi()">
                            <span style="font-size: 14px;">
                                <strong>ğŸª Bu bir maÄŸaza masrafÄ±dÄ±r</strong>
                                <br><small style="color: var(--text-secondary);">MaÄŸaza masraflarÄ± iÃ§in kargo takip sÃ¼reci uygulanÄ±r</small>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="saveDraft()">
                        ğŸ’¾ Taslak Kaydet
                    </button>
                    <button type="button" class="btn-outline" onclick="window.history.back()">
                        Ä°ptal
                    </button>
                    <button type="button" class="btn-primary" onclick="submitMasrafForm()">
                        ğŸ“¤ Onaya GÃ¶nder
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script>
        // ============================================
        // OCR OTOMATÄ°K DOLDURMA SÄ°STEMÄ°
        // ============================================

        // ============================================
        // Ã‡OKLU FÄ°Å VE SATIR BAZLI GÄ°DER SÄ°STEMÄ°
        // ============================================

        // TÃ¼m yÃ¼klenen belgeler ve gider satÄ±rlarÄ±
        let yukluBelgeler = [];
        let giderSatirlari = [];
        let satirIdSayaci = 0;
        let belgeIdSayaci = 0;

        // Karma gider kalemleri iÃ§in Ã¶rnek veriler (Migros fiÅŸi gibi)
        const karmaGiderOrnekleri = [
            {
                belgeTuru: 'fis',
                firmaAdi: 'MIGROS TÄ°CARET A.Å.',
                vergiNo: '9876543210',
                belgeNo: 'MIG-2024-458712',
                belgeTarihi: '2024-12-15',
                ocrGuvenSkoru: 96,
                satirlar: [
                    { kalem: 'GÄ±da', aciklama: 'KahvaltÄ±lÄ±k ÃœrÃ¼nler', hesapKodu: '770.01', netTutar: 245.00, kdvOrani: 10 },
                    { kalem: 'GÄ±da', aciklama: 'Ä°Ã§ecekler', hesapKodu: '770.01', netTutar: 85.00, kdvOrani: 10 },
                    { kalem: 'Temizlik', aciklama: 'Temizlik Malzemeleri', hesapKodu: '770.04', netTutar: 180.00, kdvOrani: 20 },
                    { kalem: 'KÄ±rtasiye', aciklama: 'Ofis KÄ±rtasiye', hesapKodu: '770.04', netTutar: 120.00, kdvOrani: 20 },
                    { kalem: 'Mutfak', aciklama: 'Mutfak GereÃ§leri', hesapKodu: '770.04', netTutar: 95.00, kdvOrani: 20 }
                ]
            },
            {
                belgeTuru: 'fis',
                firmaAdi: 'BÄ°M BÄ°RLEÅÄ°K MAÄAZALAR A.Å.',
                vergiNo: '8765432109',
                belgeNo: 'BIM-2024-123456',
                belgeTarihi: '2024-12-14',
                ocrGuvenSkoru: 94,
                satirlar: [
                    { kalem: 'GÄ±da', aciklama: 'AtÄ±ÅŸtÄ±rmalÄ±k', hesapKodu: '770.01', netTutar: 65.00, kdvOrani: 10 },
                    { kalem: 'GÄ±da', aciklama: 'Su ve MeÅŸrubat', hesapKodu: '770.01', netTutar: 45.00, kdvOrani: 10 },
                    { kalem: 'Temizlik', aciklama: 'Ã‡Ã¶p PoÅŸeti ve PeÃ§ete', hesapKodu: '770.04', netTutar: 35.00, kdvOrani: 20 }
                ]
            },
            {
                belgeTuru: 'fis',
                firmaAdi: 'A101 YENÄ° MAÄAZACILIK A.Å.',
                vergiNo: '7654321098',
                belgeNo: 'A101-2024-789012',
                belgeTarihi: '2024-12-13',
                ocrGuvenSkoru: 95,
                satirlar: [
                    { kalem: 'GÄ±da', aciklama: 'Ã‡ay ve Kahve', hesapKodu: '770.01', netTutar: 125.00, kdvOrani: 10 },
                    { kalem: 'KÄ±rtasiye', aciklama: 'Kalem ve Defter', hesapKodu: '770.04', netTutar: 75.00, kdvOrani: 20 },
                    { kalem: 'GÄ±da', aciklama: 'BiskÃ¼vi ve Åeker', hesapKodu: '770.01', netTutar: 55.00, kdvOrani: 10 }
                ]
            }
        ];

        let karmaOrnekIndex = 0;

        // Gider satÄ±rlarÄ±nÄ± tabloya render et
        function renderGiderSatirlari() {
            const tbody = document.getElementById('giderSatirlariBody');
            const section = document.getElementById('giderSatirlariSection');

            if (giderSatirlari.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            tbody.innerHTML = '';

            giderSatirlari.forEach((satir, index) => {
                const kdvTutar = satir.netTutar * satir.kdvOrani / 100;
                const brutTutar = satir.netTutar + kdvTutar;

                const tr = document.createElement('tr');
                tr.dataset.id = satir.id;
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="satir-checkbox" onchange="checkSelectedRows()">
                    </td>
                    <td>
                        <span class="gider-kalemi-badge" style="background: ${getKalemRenk(satir.kalem)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                            ${satir.kalem}
                        </span>
                    </td>
                    <td>${satir.aciklama}</td>
                    <td><code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">${satir.hesapKodu}</code></td>
                    <td style="text-align: right;">â‚º${satir.netTutar.toFixed(2)}</td>
                    <td style="text-align: center;">
                        <span class="kdv-badge" style="background: ${getKdvRenk(satir.kdvOrani)}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                            %${satir.kdvOrani}
                        </span>
                    </td>
                    <td style="text-align: right;">â‚º${kdvTutar.toFixed(2)}</td>
                    <td style="text-align: right; font-weight: 600;">â‚º${brutTutar.toFixed(2)}</td>
                    <td>
                        <button type="button" onclick="satirSil(${satir.id})" class="btn-icon-delete" title="SatÄ±rÄ± Ã‡Ä±kar" style="background: none; border: none; color: var(--warning-red); cursor: pointer; font-size: 16px;">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // ToplamlarÄ± gÃ¼ncelle
            hesaplaToplamlar();
            hesaplaKdvDagilimi();
        }

        // Gider kalemi rengini al
        function getKalemRenk(kalem) {
            const renkler = {
                'GÄ±da': '#4CAF50',
                'Temizlik': '#2196F3',
                'KÄ±rtasiye': '#FF9800',
                'Mutfak': '#9C27B0',
                'UlaÅŸÄ±m': '#E91E63',
                'Konaklama': '#00BCD4',
                'DiÄŸer': '#607D8B'
            };
            return renkler[kalem] || renkler['DiÄŸer'];
        }

        // KDV oranÄ± rengini al
        function getKdvRenk(oran) {
            if (oran === 0) return '#607D8B';
            if (oran === 1) return '#9E9E9E';
            if (oran === 10) return '#4CAF50';
            if (oran === 20) return '#FF9800';
            return '#2196F3';
        }

        // ToplamlarÄ± hesapla
        function hesaplaToplamlar() {
            let toplamNet = 0;
            let toplamKdv = 0;
            let toplamBrut = 0;

            giderSatirlari.forEach(satir => {
                const kdvTutar = satir.netTutar * satir.kdvOrani / 100;
                toplamNet += satir.netTutar;
                toplamKdv += kdvTutar;
                toplamBrut += satir.netTutar + kdvTutar;
            });

            document.getElementById('toplamNetTutar').textContent = 'â‚º' + toplamNet.toFixed(2);
            document.getElementById('toplamKdvTutar').textContent = 'â‚º' + toplamKdv.toFixed(2);
            document.getElementById('toplamBrutTutar').textContent = 'â‚º' + toplamBrut.toFixed(2);

            // Ana form alanlarÄ±nÄ± da gÃ¼ncelle
            document.getElementById('brutTutar').value = toplamBrut.toFixed(2);
            document.getElementById('netTutar').value = toplamNet.toFixed(2);
            document.getElementById('kdvTutari').value = toplamKdv.toFixed(2);
            updateAmountSummary();
        }

        // KDV daÄŸÄ±lÄ±mÄ±nÄ± hesapla
        function hesaplaKdvDagilimi() {
            const dagilim = {};

            giderSatirlari.forEach(satir => {
                const key = satir.kdvOrani;
                if (!dagilim[key]) {
                    dagilim[key] = { netTutar: 0, kdvTutar: 0 };
                }
                dagilim[key].netTutar += satir.netTutar;
                dagilim[key].kdvTutar += satir.netTutar * satir.kdvOrani / 100;
            });

            const container = document.getElementById('kdvDagilimi');
            container.innerHTML = '';

            Object.keys(dagilim).sort((a, b) => a - b).forEach(oran => {
                const data = dagilim[oran];
                const div = document.createElement('div');
                div.style.cssText = 'background: white; padding: 12px 16px; border-radius: 8px; border: 1px solid #e0e0e0; min-width: 140px;';
                div.innerHTML = `
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">KDV %${oran}</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--primary-orange);">â‚º${data.kdvTutar.toFixed(2)}</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Matrah: â‚º${data.netTutar.toFixed(2)}</div>
                `;
                container.appendChild(div);
            });
        }

        // SatÄ±r sil
        function satirSil(id) {
            giderSatirlari = giderSatirlari.filter(s => s.id !== id);
            renderGiderSatirlari();
            showAlert('info', 'Gider satÄ±rÄ± Ã§Ä±karÄ±ldÄ±.');
        }

        // SeÃ§ili satÄ±rlarÄ± kontrol et
        function checkSelectedRows() {
            const checkboxes = document.querySelectorAll('.satir-checkbox:checked');
            document.getElementById('btnSecilenCikar').disabled = checkboxes.length === 0;
        }

        // TÃ¼m satÄ±rlarÄ± seÃ§/kaldÄ±r
        function toggleAllRows(checkbox) {
            document.querySelectorAll('.satir-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
            checkSelectedRows();
        }

        // SeÃ§ilenleri Ã§Ä±kar
        function secilenSatirlariCikar() {
            const checkboxes = document.querySelectorAll('.satir-checkbox:checked');
            const silinecekIdler = [];

            checkboxes.forEach(cb => {
                const tr = cb.closest('tr');
                silinecekIdler.push(parseInt(tr.dataset.id));
            });

            giderSatirlari = giderSatirlari.filter(s => !silinecekIdler.includes(s.id));
            document.getElementById('selectAllRows').checked = false;
            renderGiderSatirlari();
            showAlert('info', `${silinecekIdler.length} gider satÄ±rÄ± Ã§Ä±karÄ±ldÄ±.`);
        }

        // Yeni gider satÄ±rÄ± ekle (manuel)
        function yeniGiderSatiriEkle() {
            satirIdSayaci++;
            giderSatirlari.push({
                id: satirIdSayaci,
                kalem: 'DiÄŸer',
                aciklama: 'Yeni gider satÄ±rÄ±',
                hesapKodu: '770.04',
                netTutar: 0,
                kdvOrani: 20
            });
            renderGiderSatirlari();
        }

        // Karma fiÅŸ yÃ¼kle (demo)
        function karmaFisYukle() {
            const ornek = karmaGiderOrnekleri[karmaOrnekIndex];
            karmaOrnekIndex = (karmaOrnekIndex + 1) % karmaGiderOrnekleri.length;

            // Belge bilgilerini doldur
            document.getElementById('belgeTuru').value = ornek.belgeTuru;
            document.getElementById('firmaAdi').value = ornek.firmaAdi;
            document.getElementById('vergiNo').value = ornek.vergiNo;
            document.getElementById('belgeNo').value = ornek.belgeNo;
            document.getElementById('belgeTarihi').value = ornek.belgeTarihi;

            // Gider satÄ±rlarÄ±nÄ± ekle
            ornek.satirlar.forEach(satir => {
                satirIdSayaci++;
                giderSatirlari.push({
                    id: satirIdSayaci,
                    ...satir
                });
            });

            renderGiderSatirlari();
            showAlert('success', `${ornek.firmaAdi} fiÅŸi okundu! ${ornek.satirlar.length} gider satÄ±rÄ± eklendi. (Karma KDV: %10 ve %20)`);
        }

        // Demo: Karma FiÅŸ YÃ¼kle (Migros Ã–rneÄŸi) - Sayfa baÅŸÄ±ndaki test butonu iÃ§in
        function demoKarmaFisYukle() {
            // Ã–nce mevcut verileri temizle (demo iÃ§in sÄ±fÄ±rdan baÅŸla)
            giderSatirlari = [];
            yukluBelgeler = [];
            satirIdSayaci = 0;
            belgeIdSayaci = 0;

            // Migros karma fiÅŸ Ã¶rneÄŸi (GÄ±da + KÄ±rtasiye + Temizlik + karÄ±ÅŸÄ±k KDV)
            const migrosOrnek = {
                belgeTuru: 'fis',
                firmaAdi: 'MIGROS TÄ°CARET A.Å.',
                vergiNo: '9876543210',
                belgeNo: 'MIG-2024-' + Math.floor(Math.random() * 100000),
                belgeTarihi: new Date().toISOString().split('T')[0],
                ocrGuvenSkoru: 96,
                satirlar: [
                    { kalem: 'GÄ±da', aciklama: 'KahvaltÄ±lÄ±k ÃœrÃ¼nler (Peynir, Zeytin, Yumurta)', hesapKodu: '770.01', netTutar: 245.00, kdvOrani: 10 },
                    { kalem: 'GÄ±da', aciklama: 'Ä°Ã§ecekler (Su, Meyve Suyu)', hesapKodu: '770.01', netTutar: 85.00, kdvOrani: 10 },
                    { kalem: 'Temizlik', aciklama: 'Temizlik Malzemeleri (Deterjan, Ã‡amaÅŸÄ±r Suyu)', hesapKodu: '770.04', netTutar: 180.00, kdvOrani: 20 },
                    { kalem: 'KÄ±rtasiye', aciklama: 'Ofis KÄ±rtasiye (Kalem, Defter, Dosya)', hesapKodu: '770.04', netTutar: 125.00, kdvOrani: 20 },
                    { kalem: 'Mutfak', aciklama: 'Mutfak Malzemeleri (PeÃ§ete, BulaÅŸÄ±k SÃ¼ngeri)', hesapKodu: '770.04', netTutar: 65.00, kdvOrani: 20 },
                    { kalem: 'GÄ±da', aciklama: 'AtÄ±ÅŸtÄ±rmalÄ±k (BiskÃ¼vi, Ã‡ikolata)', hesapKodu: '770.01', netTutar: 95.00, kdvOrani: 10 }
                ]
            };

            // Yeni belge oluÅŸtur
            belgeIdSayaci++;
            const yeniBelge = {
                id: belgeIdSayaci,
                belgeTuru: migrosOrnek.belgeTuru,
                firmaAdi: migrosOrnek.firmaAdi,
                vergiNo: migrosOrnek.vergiNo,
                belgeNo: migrosOrnek.belgeNo,
                belgeTarihi: migrosOrnek.belgeTarihi,
                ocrGuvenSkoru: migrosOrnek.ocrGuvenSkoru,
                satirlar: []
            };

            // Belge bilgilerini forma doldur
            document.getElementById('belgeTuru').value = migrosOrnek.belgeTuru;
            document.getElementById('firmaAdi').value = migrosOrnek.firmaAdi;
            document.getElementById('vergiNo').value = migrosOrnek.vergiNo;
            document.getElementById('belgeNo').value = migrosOrnek.belgeNo;
            document.getElementById('belgeTarihi').value = migrosOrnek.belgeTarihi;

            // Gider satÄ±rlarÄ±nÄ± ekle (belge ile iliÅŸkilendir)
            migrosOrnek.satirlar.forEach(satir => {
                satirIdSayaci++;
                const yeniSatir = {
                    id: satirIdSayaci,
                    belgeId: belgeIdSayaci,
                    ...satir
                };
                yeniBelge.satirlar.push(yeniSatir);
                giderSatirlari.push(yeniSatir);
            });

            yukluBelgeler.push(yeniBelge);

            // Tabloyu ve belge listesini render et
            renderBelgelerListesi();
            renderGiderSatirlari();

            // Belgeler listesi container'Ä±nÄ± gÃ¶ster
            document.getElementById('belgelerListesiContainer').style.display = 'block';
            document.getElementById('belgeSayisi').textContent = yukluBelgeler.length + ' Belge';

            // Bilgi mesajÄ± gÃ¶ster
            showAlert('success', 'ğŸ›’ Migros karma fiÅŸi yÃ¼klendi! 6 gider satÄ±rÄ±: 3 GÄ±da (%10 KDV), 3 Temizlik/KÄ±rtasiye/Mutfak (%20 KDV). "Yeni Belge Ekle" ile daha fazla belge ekleyebilirsiniz.');

            // Gider satÄ±rlarÄ± section'Ä±na scroll yap
            setTimeout(() => {
                document.getElementById('giderSatirlariSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // Yeni belge ekle - Ã‡oklu belge desteÄŸi
        function yeniBelgeEkle() {
            const ornek = karmaGiderOrnekleri[karmaOrnekIndex];
            karmaOrnekIndex = (karmaOrnekIndex + 1) % karmaGiderOrnekleri.length;

            belgeIdSayaci++;
            const yeniBelge = {
                id: belgeIdSayaci,
                belgeTuru: ornek.belgeTuru,
                firmaAdi: ornek.firmaAdi,
                vergiNo: ornek.vergiNo,
                belgeNo: ornek.belgeNo,
                belgeTarihi: ornek.belgeTarihi,
                ocrGuvenSkoru: ornek.ocrGuvenSkoru || 95,
                satirlar: []
            };

            // Bu belgeye ait satÄ±rlarÄ± ekle
            ornek.satirlar.forEach(satir => {
                satirIdSayaci++;
                const yeniSatir = {
                    id: satirIdSayaci,
                    belgeId: belgeIdSayaci,
                    ...satir
                };
                yeniBelge.satirlar.push(yeniSatir);
                giderSatirlari.push(yeniSatir);
            });

            yukluBelgeler.push(yeniBelge);

            // Belge listesini ve gider satÄ±rlarÄ±nÄ± render et
            renderBelgelerListesi();
            renderGiderSatirlari();

            // Belge sayÄ±sÄ±nÄ± gÃ¼ncelle
            document.getElementById('belgeSayisi').textContent = yukluBelgeler.length + ' Belge';
            document.getElementById('belgelerListesiContainer').style.display = 'block';

            showAlert('success', `ğŸ“„ ${ornek.firmaAdi} belgesi eklendi! ${ornek.satirlar.length} gider satÄ±rÄ±. Toplam ${yukluBelgeler.length} belge.`);
        }

        // Belge listesini render et
        function renderBelgelerListesi() {
            const container = document.getElementById('belgelerListesi');
            container.innerHTML = '';

            yukluBelgeler.forEach(belge => {
                const belgeToplam = belge.satirlar.reduce((acc, s) => {
                    const kdvTutar = s.netTutar * s.kdvOrani / 100;
                    return acc + s.netTutar + kdvTutar;
                }, 0);

                const div = document.createElement('div');
                div.className = 'belge-karti';
                div.style.cssText = 'background: #f8f9fa; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary-orange);';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${belge.firmaAdi}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${belge.belgeNo} â€¢ ${belge.satirlar.length} satÄ±r â€¢
                            <strong style="color: var(--primary-orange);">â‚º${belgeToplam.toFixed(2)}</strong>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                            %${belge.ocrGuvenSkoru} OCR
                        </span>
                        <button type="button" onclick="belgeSil(${belge.id})" class="btn-icon-delete" title="Belgeyi KaldÄ±r"
                            style="background: #ffebee; border: none; color: var(--warning-red); cursor: pointer; padding: 6px 10px; border-radius: 4px; font-size: 14px;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Belge sil (ve ona ait satÄ±rlarÄ± da sil)
        function belgeSil(belgeId) {
            const belge = yukluBelgeler.find(b => b.id === belgeId);
            if (!belge) return;

            if (confirm(`"${belge.firmaAdi}" belgesini ve tÃ¼m gider satÄ±rlarÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) {
                // Belgeye ait satÄ±rlarÄ± sil
                giderSatirlari = giderSatirlari.filter(s => s.belgeId !== belgeId);
                // Belgeyi sil
                yukluBelgeler = yukluBelgeler.filter(b => b.id !== belgeId);

                // Yeniden render et
                renderBelgelerListesi();
                renderGiderSatirlari();

                // Belge sayÄ±sÄ±nÄ± gÃ¼ncelle
                document.getElementById('belgeSayisi').textContent = yukluBelgeler.length + ' Belge';

                if (yukluBelgeler.length === 0) {
                    document.getElementById('belgelerListesiContainer').style.display = 'none';
                }

                showAlert('info', `"${belge.firmaAdi}" belgesi ve ${belge.satirlar.length} gider satÄ±rÄ± kaldÄ±rÄ±ldÄ±.`);
            }
        }

        // ============================================
        // MAÄAZA MASRAFI VE ATF KARGO TAKÄ°P
        // ============================================

        // MaÄŸaza masrafÄ± toggle
        function toggleMagazaMasrafi() {
            const checkbox = document.getElementById('magazaMasrafiCheckbox');
            const normalAkis = document.getElementById('normalOnayAkisi');
            const magazaAkis = document.getElementById('magazaOnayAkisi');
            const atfAlani = document.getElementById('atfKargoAlani');

            if (checkbox.checked) {
                normalAkis.style.display = 'none';
                magazaAkis.style.display = 'flex';
                atfAlani.style.display = 'block';
                showAlert('info', 'ğŸ“¦ MaÄŸaza masrafÄ± seÃ§ildi. Kargo takip sÃ¼reci uygulanacaktÄ±r.');
            } else {
                normalAkis.style.display = 'flex';
                magazaAkis.style.display = 'none';
                atfAlani.style.display = 'none';
            }
        }

        // ATF numarasÄ± doÄŸrulama ve kargo takip
        function validateATFNumarasi() {
            const atfInput = document.getElementById('atfNumarasi');
            const kargoSirketi = document.getElementById('kargoSirketi');
            const kargoDurumu = document.getElementById('kargoDurumu');

            if (atfInput.value && kargoSirketi.value) {
                // SimÃ¼le edilmiÅŸ kargo takip
                kargoDurumu.innerHTML = `
                    <span class="status-badge status-approved">Teslim Edildi</span>
                    <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">
                        ${kargoSirketi.options[kargoSirketi.selectedIndex].text} - ${atfInput.value}
                    </span>
                `;
                showAlert('success', 'âœ… Kargo teslim bilgisi alÄ±ndÄ±. Masraf artÄ±k muhasebe onayÄ±na iletilecektir.');
                return true;
            }
            return false;
        }

        // ATF kargo sitesi linki
        function getKargoTakipLinki(kargoSirketi, atfNo) {
            const linkler = {
                'yurtici': `https://www.yurticikargo.com/tr/online-servisler/gonderi-sorgula?code=${atfNo}`,
                'aras': `https://www.araskargo.com.tr/trs/kargotakip?kargono=${atfNo}`,
                'mng': `https://www.mngkargo.com.tr/gonderi-takip/${atfNo}`,
                'ptt': `https://gonderitakip.ptt.gov.tr/Tracking/${atfNo}`,
                'ups': `https://www.ups.com/track?tracknum=${atfNo}`
            };
            return linkler[kargoSirketi] || '#';
        }

        // FarklÄ± belge tÃ¼rleri iÃ§in Ã¶rnek OCR verileri (satÄ±r bazlÄ±)
        const sampleOCRDatasets = [
            {
                belgeTuru: 'fis',
                masrafTipi: 'normal',
                firmaAdi: 'KARADENIZ SOFRASI',
                vergiNo: '1234567890',
                belgeNo: 'YKF-2024-847521',
                belgeTarihi: '2024-12-09',
                brutTutar: 585.00,
                kdvOrani: 10,
                kdvTutari: 53.18,
                netTutar: 531.82,
                masrafTuru: '770.01',
                ocrGuvenSkoru: 94,
                receiptItems: [
                    { name: '2x KarÄ±ÅŸÄ±k Izgara', price: 'â‚º380.00' },
                    { name: '2x Pilav', price: 'â‚º60.00' },
                    { name: '2x Ä°Ã§ecek', price: 'â‚º50.00' },
                    { name: '1x KÃ¼nefe', price: 'â‚º95.00' }
                ],
                satirlar: [
                    { kalem: 'GÄ±da', aciklama: '2x KarÄ±ÅŸÄ±k Izgara', hesapKodu: '770.01', netTutar: 345.45, kdvOrani: 10 },
                    { kalem: 'GÄ±da', aciklama: '2x Pilav', hesapKodu: '770.01', netTutar: 54.55, kdvOrani: 10 },
                    { kalem: 'GÄ±da', aciklama: '2x Ä°Ã§ecek', hesapKodu: '770.01', netTutar: 45.45, kdvOrani: 10 },
                    { kalem: 'GÄ±da', aciklama: '1x KÃ¼nefe', hesapKodu: '770.01', netTutar: 86.36, kdvOrani: 10 }
                ]
            },
            {
                belgeTuru: 'fatura',
                masrafTipi: 'normal',
                firmaAdi: 'MIGROS TÄ°CARET A.Å.',
                vergiNo: '9876543210',
                belgeNo: 'FTR-2024-158742',
                belgeTarihi: '2024-12-10',
                brutTutar: 1250.00,
                kdvOrani: 20,
                kdvTutari: 208.33,
                netTutar: 1041.67,
                masrafTuru: '770.04',
                ocrGuvenSkoru: 97,
                receiptItems: [
                    { name: 'Ofis KÄ±rtasiye Malz.', price: 'â‚º450.00' },
                    { name: 'Temizlik Malzemeleri', price: 'â‚º320.00' },
                    { name: 'Mutfak GereÃ§leri', price: 'â‚º280.00' },
                    { name: 'Su ve Ä°Ã§ecek', price: 'â‚º200.00' }
                ],
                // Karma gider kalemleri - farklÄ± KDV oranlarÄ±
                satirlar: [
                    { kalem: 'KÄ±rtasiye', aciklama: 'Ofis KÄ±rtasiye Malz.', hesapKodu: '770.04', netTutar: 375.00, kdvOrani: 20 },
                    { kalem: 'Temizlik', aciklama: 'Temizlik Malzemeleri', hesapKodu: '770.04', netTutar: 266.67, kdvOrani: 20 },
                    { kalem: 'Mutfak', aciklama: 'Mutfak GereÃ§leri', hesapKodu: '770.04', netTutar: 233.33, kdvOrani: 20 },
                    { kalem: 'GÄ±da', aciklama: 'Su ve Ä°Ã§ecek', hesapKodu: '770.01', netTutar: 181.82, kdvOrani: 10 }
                ]
            },
            {
                belgeTuru: 'fis',
                masrafTipi: 'seyahat',
                firmaAdi: 'UBER TURKEY',
                vergiNo: '5554443332',
                belgeNo: 'UBR-2024-984521',
                belgeTarihi: '2024-12-11',
                brutTutar: 245.00,
                kdvOrani: 10,
                kdvTutari: 22.27,
                netTutar: 222.73,
                masrafTuru: '770.02',
                ocrGuvenSkoru: 92,
                receiptItems: [
                    { name: 'HavalimanÄ± Transfer', price: 'â‚º185.00' },
                    { name: 'Servis Bedeli', price: 'â‚º35.00' },
                    { name: 'BahÅŸiÅŸ', price: 'â‚º25.00' }
                ],
                satirlar: [
                    { kalem: 'UlaÅŸÄ±m', aciklama: 'HavalimanÄ± Transfer', hesapKodu: '770.02', netTutar: 168.18, kdvOrani: 10 },
                    { kalem: 'UlaÅŸÄ±m', aciklama: 'Servis Bedeli', hesapKodu: '770.02', netTutar: 31.82, kdvOrani: 10 },
                    { kalem: 'UlaÅŸÄ±m', aciklama: 'BahÅŸiÅŸ', hesapKodu: '770.02', netTutar: 22.73, kdvOrani: 10 }
                ]
            },
            {
                belgeTuru: 'fatura',
                masrafTipi: 'normal',
                firmaAdi: 'HILTON ISTANBUL',
                vergiNo: '1112223334',
                belgeNo: 'HTL-2024-005847',
                belgeTarihi: '2024-12-08',
                brutTutar: 3500.00,
                kdvOrani: 10,
                kdvTutari: 318.18,
                netTutar: 3181.82,
                masrafTuru: '770.03',
                ocrGuvenSkoru: 98,
                receiptItems: [
                    { name: '2 Gece Konaklama', price: 'â‚º3,000.00' },
                    { name: 'KahvaltÄ± Dahil', price: 'â‚º0.00' },
                    { name: 'Otopark Ãœcreti', price: 'â‚º200.00' },
                    { name: 'Minibar', price: 'â‚º300.00' }
                ],
                satirlar: [
                    { kalem: 'Konaklama', aciklama: '2 Gece Konaklama', hesapKodu: '770.03', netTutar: 2727.27, kdvOrani: 10 },
                    { kalem: 'Konaklama', aciklama: 'Otopark Ãœcreti', hesapKodu: '770.03', netTutar: 181.82, kdvOrani: 10 },
                    { kalem: 'GÄ±da', aciklama: 'Minibar', hesapKodu: '770.01', netTutar: 272.73, kdvOrani: 10 }
                ]
            },
            {
                belgeTuru: 'fatura',
                masrafTipi: 'normal',
                firmaAdi: 'AMAZON WEB SERVICES',
                vergiNo: '7778889990',
                belgeNo: 'AWS-2024-INV-45821',
                belgeTarihi: '2024-12-01',
                brutTutar: 8500.00,
                kdvOrani: 20,
                kdvTutari: 1416.67,
                netTutar: 7083.33,
                masrafTuru: '740.01',
                ocrGuvenSkoru: 99,
                receiptItems: [
                    { name: 'EC2 Instance', price: 'â‚º4,500.00' },
                    { name: 'S3 Storage', price: 'â‚º1,200.00' },
                    { name: 'RDS Database', price: 'â‚º2,000.00' },
                    { name: 'Data Transfer', price: 'â‚º800.00' }
                ],
                satirlar: [
                    { kalem: 'BiliÅŸim', aciklama: 'EC2 Instance', hesapKodu: '740.01', netTutar: 3750.00, kdvOrani: 20 },
                    { kalem: 'BiliÅŸim', aciklama: 'S3 Storage', hesapKodu: '740.01', netTutar: 1000.00, kdvOrani: 20 },
                    { kalem: 'BiliÅŸim', aciklama: 'RDS Database', hesapKodu: '740.01', netTutar: 1666.67, kdvOrani: 20 },
                    { kalem: 'BiliÅŸim', aciklama: 'Data Transfer', hesapKodu: '740.01', netTutar: 666.67, kdvOrani: 20 }
                ]
            }
        ];

        // Aktif OCR verisi (deÄŸiÅŸtirilebilir)
        let currentOCRIndex = 0;
        let ocrData = sampleOCRDatasets[currentOCRIndex];

        // OCR ile form alanlarÄ±nÄ± otomatik doldur
        function fillFormFromOCR() {
            // 1. Belge TÃ¼rÃ¼ ve Masraf Tipi otomatik doldur
            document.getElementById('belgeTuru').value = ocrData.belgeTuru;
            document.getElementById('masrafTipi').value = ocrData.masrafTipi;

            // 2. Belge Bilgileri otomatik doldur
            document.getElementById('firmaAdi').value = ocrData.firmaAdi;
            document.getElementById('vergiNo').value = ocrData.vergiNo;
            document.getElementById('belgeNo').value = ocrData.belgeNo;
            document.getElementById('belgeTarihi').value = ocrData.belgeTarihi;

            // 3. Tutar Bilgileri otomatik doldur
            document.getElementById('brutTutar').value = ocrData.brutTutar.toFixed(2);
            document.getElementById('kdvOrani').value = ocrData.kdvOrani;
            document.getElementById('kdvTutari').value = ocrData.kdvTutari.toFixed(2);
            document.getElementById('netTutar').value = ocrData.netTutar.toFixed(2);

            // 4. Masraf TÃ¼rÃ¼ / Hesap Kodu otomatik doldur ve KÄ°LÄ°TLE
            const hesapKoduSelect = document.getElementById('hesapKodu');
            hesapKoduSelect.value = ocrData.masrafTuru;
            hesapKoduSelect.disabled = true;
            hesapKoduSelect.style.backgroundColor = '#e8f5e9';
            hesapKoduSelect.style.border = '2px solid #4CAF50';
            hesapKoduSelect.style.cursor = 'not-allowed';

            // Masraf tÃ¼rÃ¼ alanÄ±na OCR kilidi bilgisi ekle
            addOCRLockIndicator();

            // Summary alanlarÄ±nÄ± gÃ¼ncelle
            document.getElementById('summaryBrut').textContent = ocrData.brutTutar.toFixed(2) + ' TL';
            document.getElementById('summaryKdv').textContent = ocrData.kdvTutari.toFixed(2) + ' TL';
            document.getElementById('summaryNet').textContent = ocrData.netTutar.toFixed(2) + ' TL';
            document.getElementById('summaryTotal').textContent = ocrData.brutTutar.toFixed(2) + ' TL';

            // OCR gÃ¼ven skoru gÃ¼ncelle
            document.getElementById('ocrConfidenceTag').textContent = '%' + ocrData.ocrGuvenSkoru + ' BaÅŸarÄ±lÄ±';

            // 5. SatÄ±r bazlÄ± gider detaylarÄ±nÄ± ekle
            if (ocrData.satirlar && ocrData.satirlar.length > 0) {
                ocrData.satirlar.forEach(satir => {
                    satirIdSayaci++;
                    giderSatirlari.push({
                        id: satirIdSayaci,
                        ...satir
                    });
                });
                renderGiderSatirlari();
            }

            // 6. Cari durumu kontrolÃ¼ (fatura tÃ¼rÃ¼ iÃ§in)
            const belgeTuru = document.getElementById('belgeTuru').value;
            const faturaTurleri = ['fatura', 'tevkifatli', 'yurtdisi', 'su', 'gider_pusulasi'];
            const cariDurumuRow = document.getElementById('cariDurumuRow');
            if (faturaTurleri.includes(belgeTuru)) {
                cariDurumuRow.style.display = 'block';
                checkCariDurumu();
            } else {
                cariDurumuRow.style.display = 'none';
            }
        }

        // OCR kilidi gÃ¶stergesi ekle
        function addOCRLockIndicator() {
            const hesapKoduGroup = document.getElementById('hesapKodu').closest('.form-group');

            // Ã–nceki kilit gÃ¶stergesini kaldÄ±r
            const existingLock = hesapKoduGroup.querySelector('.ocr-lock-indicator');
            if (existingLock) existingLock.remove();

            // Yeni kilit gÃ¶stergesi ekle
            const lockIndicator = document.createElement('div');
            lockIndicator.className = 'ocr-lock-indicator';
            lockIndicator.innerHTML = `
                <span style="display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; padding: 6px 12px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 6px; font-size: 12px; color: #2e7d32; border: 1px solid #a5d6a7;">
                    ğŸ”’ OCR tarafÄ±ndan otomatik belirlendi (DeÄŸiÅŸtirilemez)
                </span>
            `;
            hesapKoduGroup.appendChild(lockIndicator);
        }

        // FiÅŸ Ã¶nizleme gÃ¶rselini gÃ¼ncelle
        function updateReceiptPreview() {
            const receiptSimple = document.getElementById('receiptSimple');

            // Masraf tÃ¼rÃ¼ adÄ±nÄ± al
            const masrafTuruAdi = getMasrafTuruAdi(ocrData.masrafTuru);

            // FiÅŸ iÃ§eriÄŸini gÃ¼ncelle
            let itemsHtml = '';
            ocrData.receiptItems.forEach(item => {
                itemsHtml += `
                    <div class="receipt-simple-item">
                        <span>${item.name}</span>
                        <span>${item.price}</span>
                    </div>
                `;
            });

            receiptSimple.innerHTML = `
                <div class="receipt-simple-header">
                    <strong class="receipt-simple-company">${ocrData.firmaAdi}</strong>
                    <span class="receipt-simple-sub">${masrafTuruAdi}</span>
                </div>
                <div class="receipt-simple-divider"></div>
                <div class="receipt-simple-info">
                    VKN: ${ocrData.vergiNo}<br>
                    Tarih: ${formatDate(ocrData.belgeTarihi)}<br>
                    FiÅŸ No: ${ocrData.belgeNo}
                </div>
                <div class="receipt-simple-divider"></div>
                <div class="receipt-simple-items">
                    ${itemsHtml}
                </div>
                <div class="receipt-simple-totals">
                    <div class="receipt-simple-item">
                        <span>KDV (%${ocrData.kdvOrani})</span>
                        <span>â‚º${ocrData.kdvTutari.toFixed(2)}</span>
                    </div>
                    <div class="receipt-simple-item total">
                        <strong>TOPLAM</strong>
                        <strong>â‚º${ocrData.brutTutar.toFixed(2)}</strong>
                    </div>
                </div>
                <div class="receipt-simple-footer">
                    * TEÅEKKÃœRLER *<br>
                    Bu belge mali deÄŸer taÅŸÄ±r
                </div>
            `;

            // OCR baÅŸarÄ± bÃ¶lÃ¼mÃ¼ndeki Ã¶nizlemeyi de gÃ¼ncelle
            const extractedPreview = document.querySelector('.ocr-extracted-preview');
            if (extractedPreview) {
                extractedPreview.innerHTML = `
                    <div class="extracted-item">
                        <span class="extracted-label">Firma:</span>
                        <span class="extracted-value">${ocrData.firmaAdi}</span>
                    </div>
                    <div class="extracted-item">
                        <span class="extracted-label">Tarih:</span>
                        <span class="extracted-value">${formatDate(ocrData.belgeTarihi)}</span>
                    </div>
                    <div class="extracted-item">
                        <span class="extracted-label">Tutar:</span>
                        <span class="extracted-value highlight">â‚º${ocrData.brutTutar.toFixed(2)}</span>
                    </div>
                `;
            }
        }

        // Masraf tÃ¼rÃ¼ adÄ±nÄ± getir
        function getMasrafTuruAdi(kod) {
            const masrafTurleri = {
                '770.01': 'Yemek Giderleri',
                '770.02': 'UlaÅŸÄ±m Giderleri',
                '770.03': 'Konaklama Giderleri',
                '770.04': 'Ofis Malzemesi',
                '770.05': 'Temsil AÄŸÄ±rlama',
                '770.06': 'HaberleÅŸme Giderleri',
                '770.07': 'TaÅŸÄ±t Giderleri',
                '740.01': 'YazÄ±lÄ±m Giderleri',
                '740.02': 'DonanÄ±m BakÄ±m',
                '740.03': 'IT Destek Hizmetleri'
            };
            return masrafTurleri[kod] || 'Masraf';
        }

        // Tarih formatla
        function formatDate(dateStr) {
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            return dateStr;
        }

        // FarklÄ± belge yÃ¼kle butonu
        function retakePhoto() {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('collapsed');
            uploadArea.style.display = 'block';

            // File input'u tetikle
            document.getElementById('fileInput').click();
        }

        // Dosya yÃ¼kleme iÅŸleyicisi
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                // Yeni belge yÃ¼klendi - rastgele bir OCR verisi seÃ§ (demo iÃ§in)
                currentOCRIndex = (currentOCRIndex + 1) % sampleOCRDatasets.length;
                ocrData = sampleOCRDatasets[currentOCRIndex];

                // OCR iÅŸlemini baÅŸlat
                simulateNewOCR(e.target.files[0].name);
            }
        });

        // Yeni OCR iÅŸlemi simÃ¼lasyonu
        function simulateNewOCR(fileName) {
            const ocrProcessing = document.getElementById('ocrProcessing');
            const ocrSuccess = document.getElementById('ocrSuccess');
            const documentPreviewCard = document.getElementById('documentPreviewCard');
            const uploadArea = document.getElementById('uploadArea');

            // Upload alanÄ±nÄ± gizle
            uploadArea.style.display = 'none';
            uploadArea.classList.add('collapsed');

            // Ä°ÅŸleniyor animasyonunu gÃ¶ster
            documentPreviewCard.style.display = 'none';
            ocrSuccess.style.display = 'none';
            ocrProcessing.style.display = 'block';

            // Step'leri sÄ±fÄ±rla
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(step => document.getElementById(step).classList.remove('active'));

            let currentStep = 0;

            const stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(stepInterval);

                    setTimeout(() => {
                        ocrProcessing.style.display = 'none';
                        ocrSuccess.style.display = 'block';
                        documentPreviewCard.style.display = 'block';

                        // FiÅŸ Ã¶nizlemesini gÃ¼ncelle
                        updateReceiptPreview();

                        // Form alanlarÄ±nÄ± doldur
                        fillFormFromOCR();

                        // BaÅŸarÄ± mesajÄ±
                        const masrafTuruAdi = getMasrafTuruAdi(ocrData.masrafTuru);
                        showAlert('success', `Yeni belge okundu: "${ocrData.firmaAdi}" - Masraf tÃ¼rÃ¼ "${masrafTuruAdi}" olarak belirlendi ve kilitlendi.`);
                    }, 500);
                }
            }, 400);
        }

        // OCR iÅŸlemi simÃ¼lasyonu (Tekrar Oku butonu iÃ§in)
        function processOCR() {
            const ocrProcessing = document.getElementById('ocrProcessing');
            const ocrSuccess = document.getElementById('ocrSuccess');
            const documentPreviewCard = document.getElementById('documentPreviewCard');

            // Yeni OCR verisine geÃ§ (bir sonraki belge tÃ¼rÃ¼)
            currentOCRIndex = (currentOCRIndex + 1) % sampleOCRDatasets.length;
            ocrData = sampleOCRDatasets[currentOCRIndex];

            // Ä°ÅŸleniyor animasyonunu gÃ¶ster
            documentPreviewCard.style.display = 'none';
            ocrSuccess.style.display = 'none';
            ocrProcessing.style.display = 'block';

            // Step'leri sÄ±fÄ±rla
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(step => document.getElementById(step).classList.remove('active'));

            let currentStep = 0;

            const stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(stepInterval);

                    // Ä°ÅŸlem tamamlandÄ± - formu doldur
                    setTimeout(() => {
                        ocrProcessing.style.display = 'none';
                        ocrSuccess.style.display = 'block';
                        documentPreviewCard.style.display = 'block';

                        // FiÅŸ Ã¶nizlemesini gÃ¼ncelle
                        updateReceiptPreview();

                        // Form alanlarÄ±nÄ± doldur
                        fillFormFromOCR();

                        // BaÅŸarÄ± mesajÄ±
                        const masrafTuruAdi = getMasrafTuruAdi(ocrData.masrafTuru);
                        showAlert('success', `OCR baÅŸarÄ±lÄ±! "${ocrData.firmaAdi}" - Masraf tÃ¼rÃ¼ "${masrafTuruAdi}" (${ocrData.masrafTuru}) olarak belirlendi ve kilitlendi.`);
                    }, 500);
                }
            }, 400);
        }

        // Sayfa yÃ¼klendiÄŸinde OCR verilerini otomatik doldur
        document.addEventListener('DOMContentLoaded', function() {
            // YÃ¶netici kontrolÃ¼nÃ¼ yap
            checkManagerView();

            // Sayfa yÃ¼klendiÄŸinde OCR verilerini otomatik doldur
            setTimeout(() => {
                fillFormFromOCR();
                updateReceiptPreview();
            }, 500);
        });

        // Show/hide fields based on belge tÃ¼rÃ¼
        document.getElementById('belgeTuru').addEventListener('change', function() {
            const yurtdisiAlanlari = document.getElementById('yurtdisiAlanlari');
            const tevkifatAlanlari = document.getElementById('tevkifatAlanlari');
            const cariDurumuRow = document.getElementById('cariDurumuRow');

            // YurtdÄ±ÅŸÄ± alanlarÄ±
            if (this.value === 'yurtdisi') {
                yurtdisiAlanlari.style.display = 'block';
            } else {
                yurtdisiAlanlari.style.display = 'none';
            }

            // Tevkifat alanlarÄ±
            if (this.value === 'tevkifatli') {
                tevkifatAlanlari.style.display = 'block';
            } else {
                tevkifatAlanlari.style.display = 'none';
                document.getElementById('tevkifatOrani').value = '0';
                document.getElementById('tevkifatTutari').value = '';
            }

            // Cari Durumu - Sadece fatura tÃ¼rlerinde gÃ¶ster (fiÅŸ hariÃ§)
            const faturaTurleri = ['fatura', 'tevkifatli', 'yurtdisi', 'su', 'gider_pusulasi'];
            if (faturaTurleri.includes(this.value)) {
                cariDurumuRow.style.display = 'block';
                // Cari kontrol simÃ¼lasyonu
                checkCariDurumu();
            } else {
                cariDurumuRow.style.display = 'none';
            }
        });

        // Cari durumu kontrol fonksiyonu
        function checkCariDurumu() {
            const vergiNo = document.getElementById('vergiNo').value;
            const cariDurum = document.getElementById('cariDurum');
            const cariKoduText = document.getElementById('cariKoduText');
            const cariEksikUyari = document.getElementById('cariEksikUyari');

            // SimÃ¼lasyon: BazÄ± VKN'ler iÃ§in cari mevcut, bazÄ±larÄ± iÃ§in eksik
            const cariMevcutVKNler = ['1234567890', '9876543210', '1111111111', '7891234560'];

            if (cariMevcutVKNler.includes(vergiNo)) {
                cariDurum.textContent = 'Cari Mevcut';
                cariDurum.className = 'status-badge status-approved';
                cariKoduText.style.display = 'inline';
                cariEksikUyari.style.display = 'none';
            } else if (vergiNo) {
                cariDurum.textContent = 'Cari Gerekli';
                cariDurum.className = 'status-badge status-pending';
                cariKoduText.style.display = 'none';
                cariEksikUyari.style.display = 'block';
            }
        }

        // Vergi no deÄŸiÅŸtiÄŸinde cari durumunu kontrol et
        document.getElementById('vergiNo').addEventListener('change', function() {
            const belgeTuru = document.getElementById('belgeTuru').value;
            const faturaTurleri = ['fatura', 'tevkifatli', 'yurtdisi', 'su', 'gider_pusulasi'];
            if (faturaTurleri.includes(belgeTuru)) {
                checkCariDurumu();
            }
        });

        // Show/hide TaÅŸÄ±t Gideri alanlarÄ± based on hesap kodu
        document.getElementById('hesapKodu').addEventListener('change', function() {
            const tasitGideriAlanlari = document.getElementById('tasitGideriAlanlari');

            if (this.value === '770.07') {
                tasitGideriAlanlari.style.display = 'block';
                updateTasitGideri();
            } else {
                tasitGideriAlanlari.style.display = 'none';
                document.getElementById('giderKismi').value = '';
                document.getElementById('kkegKismi').value = '';
            }
        });

        // Tevkifat hesaplama fonksiyonu
        function updateTevkifat() {
            const kdvTutari = parseFloat(document.getElementById('kdvTutari').value) || 0;
            const tevkifatOrani = document.getElementById('tevkifatOrani').value;

            if (tevkifatOrani && tevkifatOrani !== '0') {
                const [pay, payda] = tevkifatOrani.split('/').map(Number);
                const tevkifatTutari = kdvTutari * (pay / payda);
                document.getElementById('tevkifatTutari').value = tevkifatTutari.toFixed(2);
            } else {
                document.getElementById('tevkifatTutari').value = '';
            }
        }

        // TaÅŸÄ±t Gideri %70/%30 ayrÄ±mÄ± hesaplama fonksiyonu
        function updateTasitGideri() {
            const netTutar = parseFloat(document.getElementById('netTutar').value) || 0;
            const hesapKodu = document.getElementById('hesapKodu').value;

            if (hesapKodu === '770.07' && netTutar > 0) {
                const giderKismi = netTutar * 0.70;
                const kkegKismi = netTutar * 0.30;

                document.getElementById('giderKismi').value = giderKismi.toFixed(2);
                document.getElementById('kkegKismi').value = kkegKismi.toFixed(2);
            }
        }

        // Override updateAmountSummary to also update tevkifat and tasit gideri
        const originalUpdateAmountSummary = window.updateAmountSummary || function() {};
        window.updateAmountSummary = function() {
            originalUpdateAmountSummary();

            // Tutar alanlarÄ± gÃ¼ncelle
            const brutTutar = parseFloat(document.getElementById('brutTutar').value) || 0;
            const kdvOrani = parseFloat(document.getElementById('kdvOrani').value) || 0;

            const kdvHaricTutar = brutTutar / (1 + kdvOrani / 100);
            const kdvTutari = brutTutar - kdvHaricTutar;

            document.getElementById('kdvTutari').value = kdvTutari.toFixed(2);
            document.getElementById('netTutar').value = kdvHaricTutar.toFixed(2);

            // Summary alanlarÄ± gÃ¼ncelle
            document.getElementById('summaryBrut').textContent = brutTutar.toFixed(2) + ' TL';
            document.getElementById('summaryKdv').textContent = kdvTutari.toFixed(2) + ' TL';
            document.getElementById('summaryNet').textContent = kdvHaricTutar.toFixed(2) + ' TL';
            document.getElementById('summaryTotal').textContent = brutTutar.toFixed(2) + ' TL';

            // Tevkifat gÃ¼ncelle
            if (document.getElementById('belgeTuru').value === 'tevkifatli') {
                updateTevkifat();
            }

            // TaÅŸÄ±t gideri gÃ¼ncelle
            if (document.getElementById('hesapKodu').value === '770.07') {
                updateTasitGideri();
            }

            // Tutar limiti kontrolÃ¼
            checkTutarLimiti(brutTutar);
        };

        // ============================================
        // KURAL SETLERÄ° - VALÄ°DASYON FONKSÄ°YONLARI
        // ============================================

        // Kural 1: Tutar Limiti KontrolÃ¼ (DeÄŸiÅŸtirilebilir)
        const TUTAR_LIMITI = 50000; // TL (ayarlanabilir)

        function checkTutarLimiti(tutar) {
            const alertContainer = document.getElementById('alertContainer');
            const existingLimitAlert = document.getElementById('limitAlert');

            if (tutar > TUTAR_LIMITI) {
                if (!existingLimitAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'limitAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">ğŸš«</span>
                        <div>
                            <strong>Tutar Limiti AÅŸÄ±ldÄ±!</strong><br>
                            Masraf tutarÄ± belirlenen limit olan <strong>${TUTAR_LIMITI.toLocaleString('tr-TR')} TL</strong>'yi aÅŸmaktadÄ±r.
                            Bu masraf otomatik olarak onaylanamaz.
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
            } else if (existingLimitAlert) {
                existingLimitAlert.remove();
            }
        }

        // Kural 2: Kabul Edilmeyen Gider Kalemleri (DeÄŸiÅŸtirilebilir)
        const REDDEDILEN_GIDER_KALEMLERI = [
            'tekel', 'alkol', 'sigara', 'tÃ¼tÃ¼n', 'iÃ§ki', 'bira', 'ÅŸarap', 'rakÄ±',
            'viski', 'votka', 'kumar', 'bahis', 'casino'
        ];

        function checkYasakliGiderKalemi(aciklama) {
            const alertContainer = document.getElementById('alertContainer');
            const existingGiderAlert = document.getElementById('giderAlert');
            const lowercaseAciklama = aciklama.toLowerCase();

            const bulunanYasakli = REDDEDILEN_GIDER_KALEMLERI.find(kalem =>
                lowercaseAciklama.includes(kalem)
            );

            if (bulunanYasakli) {
                if (!existingGiderAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'giderAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">â›”</span>
                        <div>
                            <strong>Kabul Edilmeyen Gider Kalemi!</strong><br>
                            AÃ§Ä±klamada kabul edilmeyen gider kalemi tespit edildi: <strong>"${bulunanYasakli}"</strong><br>
                            <small>Bu tÃ¼r masraflar ÅŸirket politikasÄ± gereÄŸi kabul edilmemektedir.</small>
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
                return false;
            } else if (existingGiderAlert) {
                existingGiderAlert.remove();
            }
            return true;
        }

        // AÃ§Ä±klama alanÄ± kontrolÃ¼
        document.getElementById('aciklama').addEventListener('input', function() {
            checkYasakliGiderKalemi(this.value);
        });

        // Kural 3: MÃ¼kerrer Fatura KontrolÃ¼ (SimÃ¼lasyon)
        // GerÃ§ek uygulamada API Ã§aÄŸrÄ±sÄ± ile kontrol edilecek
        const GECMIS_FATURALAR = [
            { firmaAdi: 'KARADENIZ SOFRASI', belgeNo: 'YKF-2024-847520', belgeTarihi: '2024-12-08' },
            { firmaAdi: 'MIGROS', belgeNo: 'F-2024-001234', belgeTarihi: '2024-12-07' }
        ];

        function checkMukerrerFatura() {
            const firmaAdi = document.getElementById('firmaAdi').value.toUpperCase();
            const belgeNo = document.getElementById('belgeNo').value;
            const belgeTarihi = document.getElementById('belgeTarihi').value;

            const alertContainer = document.getElementById('alertContainer');
            const existingMukerrerAlert = document.getElementById('mukerrerAlert');

            const mukerrer = GECMIS_FATURALAR.find(f =>
                f.firmaAdi.toUpperCase() === firmaAdi &&
                f.belgeNo === belgeNo &&
                f.belgeTarihi === belgeTarihi
            );

            if (mukerrer) {
                if (!existingMukerrerAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'mukerrerAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">âš ï¸</span>
                        <div>
                            <strong>MÃ¼kerrer Fatura UyarÄ±sÄ±!</strong><br>
                            Bu fatura daha Ã¶nce sisteme girilmiÅŸ gÃ¶rÃ¼nÃ¼yor.<br>
                            <small>Firma: ${firmaAdi} | Belge No: ${belgeNo} | Tarih: ${belgeTarihi}</small>
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
                return false;
            } else if (existingMukerrerAlert) {
                existingMukerrerAlert.remove();
            }
            return true;
        }

        // Belge alanlarÄ± deÄŸiÅŸtiÄŸinde mÃ¼kerrer kontrolÃ¼
        ['firmaAdi', 'belgeNo', 'belgeTarihi'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('change', checkMukerrerFatura);
        });

        // Kural 4: Åirket EÅŸleÅŸme KontrolÃ¼
        // Ã‡alÄ±ÅŸanÄ±n bordro ÅŸirketi ile fatura ÅŸirketi uyumlu olmalÄ±
        const KULLANICI_BORDRO_SIRKETI = 'flo_teknoloji'; // Ã–rnek: Login'den gelecek
        const SIRKET_VKN_ESLESMESI = {
            'flo_magazacilik': ['1234567890', '9876543210'],
            'flo_teknoloji': ['1111111111', '2222222222'],
            'turuncu': ['3333333333', '4444444444'],
            'flo_ic_dis': ['5555555555', '6666666666']
        };

        function checkSirketEslesmesi() {
            const secilenSirket = document.getElementById('sirket').value;
            const alertContainer = document.getElementById('alertContainer');
            const existingSirketAlert = document.getElementById('sirketAlert');

            if (secilenSirket !== KULLANICI_BORDRO_SIRKETI) {
                if (!existingSirketAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'sirketAlert';
                    alert.className = 'alert alert-warning';
                    alert.innerHTML = `
                        <span class="alert-icon">âš ï¸</span>
                        <div>
                            <strong>Åirket UyumsuzluÄŸu!</strong><br>
                            Bordro ÅŸirketiniz ile seÃ§ilen ÅŸirket farklÄ±.
                            FarklÄ± ÅŸirket adÄ±na masraf giriÅŸi iÃ§in gerekÃ§e belirtmeniz gerekmektedir.
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
            } else if (existingSirketAlert) {
                existingSirketAlert.remove();
            }
        }

        document.getElementById('sirket').addEventListener('change', checkSirketEslesmesi);

        // Form submit validasyonu
        const originalSubmitMasrafForm = window.submitMasrafForm || function() {};
        window.submitMasrafForm = function() {
            const brutTutar = parseFloat(document.getElementById('brutTutar').value) || 0;
            const aciklama = document.getElementById('aciklama').value;
            const belgeTuru = document.getElementById('belgeTuru').value;

            // Disabled select'in deÄŸerini al (OCR tarafÄ±ndan kilitlenmiÅŸ olabilir)
            const hesapKoduSelect = document.getElementById('hesapKodu');
            const hesapKodu = hesapKoduSelect.value;

            // Zorunlu alan kontrolleri
            if (!belgeTuru) {
                showValidationAlert('LÃ¼tfen belge tÃ¼rÃ¼nÃ¼ seÃ§iniz.', 'error');
                return;
            }
            if (!hesapKodu) {
                showValidationAlert('LÃ¼tfen masraf tÃ¼rÃ¼ / hesap kodunu seÃ§iniz.', 'error');
                return;
            }
            if (!aciklama.trim()) {
                showValidationAlert('Masraf aÃ§Ä±klamasÄ± zorunludur.', 'error');
                return;
            }
            if (brutTutar <= 0) {
                showValidationAlert('GeÃ§erli bir tutar giriniz.', 'error');
                return;
            }

            // Kural seti kontrolleri
            if (brutTutar > TUTAR_LIMITI) {
                showValidationAlert('Tutar limiti aÅŸÄ±ldÄ±ÄŸÄ± iÃ§in bu masraf gÃ¶nderilemez.', 'error');
                return;
            }

            if (!checkYasakliGiderKalemi(aciklama)) {
                showValidationAlert('Kabul edilmeyen gider kalemi iÃ§eren masraf gÃ¶nderilemez.', 'error');
                return;
            }

            if (!checkMukerrerFatura()) {
                showValidationAlert('MÃ¼kerrer fatura tespit edildi. LÃ¼tfen kontrol ediniz.', 'error');
                return;
            }

            // TÃ¼m kontroller geÃ§ti, formu gÃ¶nder
            showAlert('success', 'Masraf talebiniz baÅŸarÄ±yla onaya gÃ¶nderildi!');
            setTimeout(() => {
                window.location.href = 'masraf-listesi.html';
            }, 2000);
        };

        // Alert gÃ¶sterme fonksiyonu (main.js ile uyumlu)
        // Not: main.js'deki showAlert(type, message) fonksiyonunu kullanÄ±yoruz
        // Bu sayfaya Ã¶zel validasyon alertleri iÃ§in ayrÄ± bir fonksiyon tanÄ±mlÄ±yoruz
        function showValidationAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span class="alert-icon">${type === 'error' ? 'âŒ' : 'âœ…'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 18px;">Ã—</button>
            `;
            alertContainer.prepend(alert);

            if (type === 'success') {
                setTimeout(() => alert.remove(), 5000);
            }
        }

        // YÃ¶netici gÃ¶rÃ¼nÃ¼mÃ¼ kontrolÃ¼
        function checkManagerView() {
            const urlParams = new URLSearchParams(window.location.search);
            const isManagerRole = urlParams.get('role') === 'manager';

            if (isManagerRole) {
                document.getElementById('sidebarEmployee').style.display = 'none';
                document.getElementById('sidebarManager').style.display = 'block';
            }
        }

    </script>
</body>
</html>
