<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masraf Formu - FLOConnect</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
        <div class="logo">FLO<span style="font-weight: 300;">Connect</span></div>
        <div class="header-actions">
            <button class="notification-btn">ğŸ”” Bildirimler</button>
        </div>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar - Employee View -->
        <aside class="sidebar" id="sidebarEmployee">
            <button class="sidebar-close" onclick="closeMobileMenu()">âœ•</button>
            <div class="user-profile">
                <div class="user-avatar">BT</div>
                <div class="user-name">Berat TanrÄ±verdi</div>
                <div class="user-title">KÄ±demli Uzman</div>
                <div class="user-role">ÃœrÃ¼n TasarÄ±m/UX MÃ¼d.</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="calisan-anasayfa.html" class="nav-link">
                        <span class="nav-icon">ğŸ </span>
                        Anasayfa
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-formu.html" class="nav-link active">
                        <span class="nav-icon">ğŸ§¾</span>
                        Yeni Masraf GiriÅŸi
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html" class="nav-link">
                        <span class="nav-icon">ğŸ“‹</span>
                        Masraf Taleplerim
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="window.location.href='index.html'">
                ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
            </button>
        </aside>

        <!-- Sidebar - Manager View -->
        <aside class="sidebar" id="sidebarManager" style="display: none;">
            <button class="sidebar-close" onclick="closeMobileMenu()">âœ•</button>
            <div class="user-profile">
                <div class="user-avatar" style="background: linear-gradient(135deg, var(--primary-burgundy), #A0516D);">MY</div>
                <div class="user-name">Mehmet YÄ±lmaz</div>
                <div class="user-title">Dijital ÃœrÃ¼nler DirektÃ¶rÃ¼</div>
                <div class="user-role" style="background: linear-gradient(135deg, var(--primary-burgundy), #A0516D); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px;">4. Derece Onay Yetkisi</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="yonetici-anasayfa.html" class="nav-link">
                        <span class="nav-icon">ğŸ </span>
                        Anasayfa
                    </a>
                </li>
                <li class="nav-item">
                    <a href="onay-listesi.html" class="nav-link">
                        <span class="nav-icon">â³</span>
                        Onay Bekleyenler
                        <span style="background: var(--warning-red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: auto;">7</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html?view=all" class="nav-link">
                        <span class="nav-icon">ğŸ“‹</span>
                        MasraflarÄ±m
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-listesi.html?view=team" class="nav-link">
                        <span class="nav-icon">ğŸ‘¥</span>
                        Ekip MasraflarÄ±
                    </a>
                </li>
                <li class="nav-item">
                    <a href="masraf-formu.html?role=manager" class="nav-link active">
                        <span class="nav-icon">ğŸ§¾</span>
                        Masraf GiriÅŸi
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="window.location.href='index.html'">
                ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="calisan-anasayfa.html">Anasayfa</a>
                <span>â€º</span>
                <span>Yeni Masraf GiriÅŸi</span>
            </div>

            <h1 class="page-title">Yeni Masraf GiriÅŸi</h1>

            <!-- Warning Alert -->
            <div class="alert alert-warning">
                <span class="alert-icon">âš ï¸</span>
                <div>
                    <strong>Ã–nemli:</strong> FiÅŸ veya fatura gÃ¶rselini yÃ¼kleyiniz. OCR sistemi belgenizi otomatik olarak okuyacaktÄ±r.
                    Okunan bilgileri kontrol edip onaylamanÄ±z gerekmektedir.
                </div>
            </div>

            <div class="form-container">
                <!-- Section 1: Belge YÃ¼kleme -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">1</span>
                        Belge YÃ¼kleme (OCR)
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Belge TÃ¼rÃ¼</label>
                            <select class="form-select" id="belgeTuru">
                                <option value="">SeÃ§iniz...</option>
                                <option value="fatura">Fatura</option>
                                <option value="tevkifatli">TevkifatlÄ± Fatura</option>
                                <option value="fis">Yazar Kasa / Perakende SatÄ±ÅŸ FiÅŸi</option>
                                <option value="yurtdisi">YurtdÄ±ÅŸÄ± FaturasÄ±</option>
                                <option value="dekont">Dekont / HarÃ§ / Makbuz</option>
                                <option value="su">Su FaturasÄ±</option>
                                <option value="gider_pusulasi">Gider PusulasÄ±</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Masraf Tipi</label>
                            <select class="form-select" id="masrafTipi">
                                <option value="">SeÃ§iniz...</option>
                                <option value="normal">Normal Masraf</option>
                                <option value="seyahat">Seyahat MasrafÄ±</option>
                                <option value="kredi_karti">Kredi KartÄ± MasrafÄ±</option>
                                <option value="kiralama">Kiralama FaturasÄ±</option>
                            </select>
                        </div>
                    </div>

                    <!-- Belge GÃ¶rseli Preview -->
                    <div class="document-preview-card" id="documentPreviewCard">
                        <h3 class="preview-title">ğŸ–¼ï¸ Belge GÃ¶rseli (OCR ile Okundu)</h3>
                        <div class="document-preview-container">
                            <!-- SimÃ¼le edilmiÅŸ fiÅŸ gÃ¶rseli -->
                            <div class="receipt-simple" id="receiptSimple">
                                <div class="receipt-simple-header">
                                    <strong class="receipt-simple-company">KARADENIZ SOFRASI</strong>
                                    <span class="receipt-simple-sub">Restoran & Lokanta</span>
                                </div>
                                <div class="receipt-simple-divider"></div>
                                <div class="receipt-simple-info">
                                    VKN: 1234567890<br>
                                    Tarih: 09.12.2024 13:45<br>
                                    FiÅŸ No: YKF-2024-847521
                                </div>
                                <div class="receipt-simple-divider"></div>
                                <div class="receipt-simple-items">
                                    <div class="receipt-simple-item">
                                        <span>2x KarÄ±ÅŸÄ±k Izgara</span>
                                        <span>â‚º380.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>2x Pilav</span>
                                        <span>â‚º60.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>2x Ä°Ã§ecek</span>
                                        <span>â‚º50.00</span>
                                    </div>
                                    <div class="receipt-simple-item">
                                        <span>1x KÃ¼nefe</span>
                                        <span>â‚º95.00</span>
                                    </div>
                                </div>
                                <div class="receipt-simple-totals">
                                    <div class="receipt-simple-item">
                                        <span>KDV (%10)</span>
                                        <span>â‚º53.18</span>
                                    </div>
                                    <div class="receipt-simple-item total">
                                        <strong>TOPLAM</strong>
                                        <strong>â‚º585.00</strong>
                                    </div>
                                </div>
                                <div class="receipt-simple-footer">
                                    * TEÅEKKÃœRLER *<br>
                                    Bu belge mali deÄŸer taÅŸÄ±r
                                </div>
                            </div>

                            <div class="ocr-confidence-badge">
                                <span>ğŸ¤– OCR GÃ¼ven Skoru:</span>
                                <span class="confidence-tag" id="ocrConfidenceTag">%94 BaÅŸarÄ±lÄ±</span>
                            </div>
                        </div>

                        <div class="document-actions">
                            <button class="btn-action-secondary" onclick="retakePhoto()">
                                ğŸ”„ FarklÄ± Belge YÃ¼kle
                            </button>
                            <button class="btn-action-primary" onclick="processOCR()">
                                âœ¨ OCR ile Tekrar Oku
                            </button>
                        </div>
                    </div>

                    <!-- OCR Processing Animation -->
                    <div class="ocr-processing" id="ocrProcessing" style="display: none;">
                        <div class="processing-animation">
                            <div class="scan-line"></div>
                            <div class="processing-icon">ğŸ”</div>
                        </div>
                        <div class="processing-text">Belge Okunuyor...</div>
                        <div class="processing-steps">
                            <div class="step-item" id="step1">
                                <span class="step-dot"></span>
                                <span>GÃ¶rÃ¼ntÃ¼ analiz ediliyor...</span>
                            </div>
                            <div class="step-item" id="step2">
                                <span class="step-dot"></span>
                                <span>Metin tanÄ±nÄ±yor...</span>
                            </div>
                            <div class="step-item" id="step3">
                                <span class="step-dot"></span>
                                <span>Veriler Ã§Ä±karÄ±lÄ±yor...</span>
                            </div>
                            <div class="step-item" id="step4">
                                <span class="step-dot"></span>
                                <span>Form dolduruluyor...</span>
                            </div>
                        </div>
                    </div>

                    <!-- OCR Success Result -->
                    <div class="ocr-success" id="ocrSuccess" style="display: none;">
                        <div class="success-header">
                            <div class="success-icon">âœ…</div>
                            <div class="success-text">
                                <h3>OCR BaÅŸarÄ±lÄ±!</h3>
                                <p>Belge bilgileri otomatik olarak dolduruldu</p>
                            </div>
                            <div class="confidence-score">
                                <div class="score-circle">
                                    <span class="score-value">94%</span>
                                </div>
                                <span class="score-label">DoÄŸruluk</span>
                            </div>
                        </div>
                        <div class="ocr-extracted-preview">
                            <div class="extracted-item">
                                <span class="extracted-label">Firma:</span>
                                <span class="extracted-value">KARADENIZ SOFRASI</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Tarih:</span>
                                <span class="extracted-value">09.12.2024</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Tutar:</span>
                                <span class="extracted-value highlight">â‚º585.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Area (Yeni Belge YÃ¼kleme) -->
                    <div class="file-upload-area collapsed" id="uploadArea">
                        <input type="file" id="fileInput" accept="image/*,.pdf" multiple>
                        <div class="upload-icon">ğŸ“¤</div>
                        <div class="upload-text">FarklÄ± Bir Belge YÃ¼kle</div>
                        <div class="upload-hint">veya tÄ±klayarak dosya seÃ§in (JPG, PNG, PDF - Max 10MB)</div>
                    </div>

                    <!-- Uploaded Files List -->
                    <div class="uploaded-files" id="uploadedFiles"></div>
                </div>

                <!-- Section 2: Belge Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">2</span>
                        Belge Bilgileri
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Belge/Fatura No</label>
                            <input type="text" class="form-input" id="belgeNo" placeholder="Otomatik okunacak">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Belge Tarihi</label>
                            <input type="date" class="form-input" id="belgeTarihi">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Firma/TedarikÃ§i AdÄ±</label>
                            <input type="text" class="form-input" id="firmaAdi" placeholder="Otomatik okunacak">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vergi Kimlik No</label>
                            <input type="text" class="form-input" id="vergiNo" placeholder="Otomatik okunacak">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Cari Durumu</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <span class="status-badge status-approved" id="cariDurum">Cari Mevcut</span>
                                <span style="font-size: 13px; color: var(--text-secondary);">SAP Cari Kodu: 320.01.001</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Tutar Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">3</span>
                        Tutar Bilgileri
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">BrÃ¼t Tutar (TL)</label>
                            <input type="number" class="form-input" id="brutTutar" step="0.01" placeholder="0.00" oninput="updateAmountSummary()">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">KDV OranÄ± (%)</label>
                            <select class="form-select" id="kdvOrani" onchange="updateAmountSummary()">
                                <option value="0">%0</option>
                                <option value="1">%1</option>
                                <option value="10">%10</option>
                                <option value="20" selected>%20</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">KDV TutarÄ± (TL)</label>
                            <input type="number" class="form-input" id="kdvTutari" step="0.01" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">KDV HariÃ§ Tutar (TL)</label>
                            <input type="number" class="form-input" id="netTutar" step="0.01" readonly style="background: #f5f5f5;">
                        </div>
                    </div>

                    <!-- Tevkifat AlanlarÄ± (TevkifatlÄ± Fatura iÃ§in) -->
                    <div id="tevkifatAlanlari" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Tevkifat OranÄ±</label>
                                <select class="form-select" id="tevkifatOrani" onchange="updateTevkifat()">
                                    <option value="0">Tevkifat Yok</option>
                                    <option value="2/10">2/10 - YapÄ±m Ä°ÅŸleri</option>
                                    <option value="4/10">4/10 - Temizlik Hizmetleri</option>
                                    <option value="5/10">5/10 - Makine BakÄ±m</option>
                                    <option value="7/10">7/10 - EtÃ¼t, Plan Proje</option>
                                    <option value="9/10">9/10 - YapÄ± Denetim</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tevkifat TutarÄ± (TL)</label>
                                <input type="number" class="form-input" id="tevkifatTutari" step="0.01" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <span class="alert-icon">â„¹ï¸</span>
                            <span>TevkifatlÄ± faturalarda KDV'nin bir kÄ±smÄ± satÄ±cÄ± tarafÄ±ndan beyan edilir.</span>
                        </div>
                    </div>

                    <!-- TaÅŸÄ±t Gideri AyrÄ±mÄ± (%70 Gider / %30 KKEG) -->
                    <div id="tasitGideriAlanlari" style="display: none;">
                        <div class="alert alert-warning">
                            <span class="alert-icon">âš ï¸</span>
                            <div>
                                <strong>TaÅŸÄ±t Gideri AyrÄ±mÄ±:</strong> Bu masraf taÅŸÄ±t gideri olarak iÅŸaretlendi.<br>
                                <small>Tutar otomatik olarak %70 Gider ve %30 KKEG olarak ayrÄ±lacaktÄ±r.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Gider KÄ±smÄ± (%70)</label>
                                <input type="number" class="form-input" id="giderKismi" step="0.01" readonly style="background: #E8F5E9;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">KKEG KÄ±smÄ± (%30)</label>
                                <input type="number" class="form-input" id="kkegKismi" step="0.01" readonly style="background: #FFF3E0;">
                            </div>
                        </div>
                    </div>

                    <!-- YurtdÄ±ÅŸÄ± Masraf AlanlarÄ± (gizli) -->
                    <div id="yurtdisiAlanlari" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">DÃ¶viz TutarÄ±</label>
                                <input type="number" class="form-input" id="yurtdisiTutar" step="0.01" oninput="convertCurrency()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Para Birimi</label>
                                <select class="form-select" id="paraBirimi">
                                    <option value="USD">USD - Amerikan DolarÄ±</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - Ä°ngiliz Sterlini</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kur OranÄ±</label>
                                <input type="number" class="form-input" id="kurOrani" step="0.0001" oninput="convertCurrency()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TL KarÅŸÄ±lÄ±ÄŸÄ±</label>
                                <input type="number" class="form-input" id="tlKarsiligi" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                    </div>

                    <!-- Amount Summary -->
                    <div class="amount-summary">
                        <div class="amount-row">
                            <span>BrÃ¼t Tutar:</span>
                            <span id="summaryBrut">0.00 TL</span>
                        </div>
                        <div class="amount-row">
                            <span>KDV TutarÄ±:</span>
                            <span id="summaryKdv">0.00 TL</span>
                        </div>
                        <div class="amount-row">
                            <span>KDV HariÃ§ Tutar:</span>
                            <span id="summaryNet">0.00 TL</span>
                        </div>
                        <div class="amount-row total">
                            <span>Toplam Masraf:</span>
                            <span id="summaryTotal">0.00 TL</span>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Masraf DetaylarÄ± -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">4</span>
                        Masraf DetaylarÄ±
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Masraf Merkezi</label>
                            <input type="text" class="form-input" id="masrafMerkezi" value="50G1022 - Dijital ÃœrÃ¼nler" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Masraf TÃ¼rÃ¼ / Hesap Kodu</label>
                            <select class="form-select" id="hesapKodu">
                                <option value="">SeÃ§iniz...</option>
                                <optgroup label="Genel YÃ¶netim Giderleri - Merkez (770)">
                                    <option value="770.01">770.01 - Yemek Giderleri</option>
                                    <option value="770.02">770.02 - UlaÅŸÄ±m Giderleri</option>
                                    <option value="770.03">770.03 - Konaklama Giderleri</option>
                                    <option value="770.04">770.04 - Ofis Malzemesi</option>
                                    <option value="770.05">770.05 - Temsil AÄŸÄ±rlama</option>
                                    <option value="770.06">770.06 - HaberleÅŸme Giderleri</option>
                                    <option value="770.07">770.07 - TaÅŸÄ±t Giderleri</option>
                                </optgroup>
                                <optgroup label="Pazarlama SatÄ±ÅŸ DaÄŸÄ±tÄ±m - MaÄŸazalar (760)">
                                    <option value="760.01">760.01 - MaÄŸaza Giderleri</option>
                                    <option value="760.02">760.02 - TanÄ±tÄ±m Giderleri</option>
                                    <option value="760.03">760.03 - SatÄ±ÅŸ Promosyon</option>
                                </optgroup>
                                <optgroup label="Ar-Ge / TasarÄ±m Merkezi (750)">
                                    <option value="750.01">750.01 - Proje Giderleri</option>
                                    <option value="750.02">750.02 - AraÅŸtÄ±rma Giderleri</option>
                                    <option value="750.03">750.03 - Test ve GeliÅŸtirme</option>
                                </optgroup>
                                <optgroup label="Teknoloji Teknik Destek (740)">
                                    <option value="740.01">740.01 - YazÄ±lÄ±m Giderleri</option>
                                    <option value="740.02">740.02 - DonanÄ±m BakÄ±m</option>
                                    <option value="740.03">740.03 - IT Destek Hizmetleri</option>
                                </optgroup>
                                <optgroup label="Fabrika Giderleri (730)">
                                    <option value="730.01">730.01 - Ãœretim Giderleri</option>
                                    <option value="730.02">730.02 - Hammadde Giderleri</option>
                                    <option value="730.03">730.03 - BakÄ±m OnarÄ±m</option>
                                </optgroup>
                                <optgroup label="ÅirketlerarasÄ± YansÄ±tmalar (198)">
                                    <option value="198.01">198.01 - FLO MaÄŸazacÄ±lÄ±k YansÄ±tma</option>
                                    <option value="198.02">198.02 - FLO Teknoloji YansÄ±tma</option>
                                    <option value="198.03">198.03 - Turuncu YansÄ±tma</option>
                                </optgroup>
                                <optgroup label="Kiralama Giderleri (632)">
                                    <option value="632.04.01">632.04.01 - MaÄŸaza Asgari Kira</option>
                                    <option value="632.04.02">632.04.02 - Ortak YÃ¶netim Gideri</option>
                                    <option value="632.04.03">632.04.03 - Ciro Kira Gideri</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Proje Kodu (Opsiyonel)</label>
                            <select class="form-select" id="projeKodu">
                                <option value="">Proje seÃ§iniz (opsiyonel)...</option>
                                <option value="PRJ001">PRJ001 - E-Ticaret Yenileme</option>
                                <option value="PRJ002">PRJ002 - Mobil Uygulama v2</option>
                                <option value="PRJ003">PRJ003 - CRM Entegrasyonu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Åirket</label>
                            <select class="form-select" id="sirket">
                                <option value="flo_magazacilik">FLO MaÄŸazacÄ±lÄ±k</option>
                                <option value="turuncu">Turuncu AyakkabÄ±</option>
                                <option value="flo_teknoloji">FLO Teknoloji</option>
                                <option value="flo_ic_dis">FLO Ä°Ã§ DÄ±ÅŸ Ticaret</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label required">Masraf AÃ§Ä±klamasÄ±</label>
                            <textarea class="form-textarea" id="aciklama" placeholder="MasrafÄ±n ne iÃ§in yapÄ±ldÄ±ÄŸÄ±nÄ± detaylÄ± aÃ§Ä±klayÄ±nÄ±z..." required></textarea>
                            <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                                * Bu aÃ§Ä±klama hesap eÅŸleÅŸtirmesinde kullanÄ±lacaktÄ±r. LÃ¼tfen detaylÄ± yazÄ±nÄ±z.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Onay Bilgileri -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span class="section-number">5</span>
                        Onay AkÄ±ÅŸÄ± Bilgileri
                    </h2>

                    <div class="alert alert-info">
                        <span class="alert-icon">â„¹ï¸</span>
                        <div>
                            Masraf tutarÄ±nÄ±za gÃ¶re onay akÄ±ÅŸÄ± otomatik belirlenecektir.
                            <strong>7.500 TL</strong> altÄ± masraflar sadece birim mÃ¼dÃ¼rÃ¼ onayÄ± ile tamamlanÄ±r.
                        </div>
                    </div>

                    <!-- Approval Timeline Preview -->
                    <div class="approval-timeline">
                        <div class="approval-step completed">
                            <div class="step-circle">âœ“</div>
                            <div class="step-label">Talep OluÅŸtur</div>
                            <div class="step-person">Berat TanrÄ±verdi</div>
                        </div>
                        <div class="approval-step current">
                            <div class="step-circle">1</div>
                            <div class="step-label">YÃ¶netici OnayÄ±</div>
                            <div class="step-person">Mehmet YÄ±lmaz (5.Derece)</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Muhasebe OnayÄ±</div>
                            <div class="step-person">Muhasebe Havuzu</div>
                        </div>
                        <div class="approval-step">
                            <div class="step-circle">3</div>
                            <div class="step-label">SAP AktarÄ±m</div>
                            <div class="step-person">Otomatik</div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="saveDraft()">
                        ğŸ’¾ Taslak Kaydet
                    </button>
                    <button type="button" class="btn-outline" onclick="window.history.back()">
                        Ä°ptal
                    </button>
                    <button type="button" class="btn-primary" onclick="submitMasrafForm()">
                        ğŸ“¤ Onaya GÃ¶nder
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script>
        // ============================================
        // OCR OTOMATÄ°K DOLDURMA SÄ°STEMÄ°
        // ============================================

        // SimÃ¼le edilmiÅŸ OCR verisi (gerÃ§ek uygulamada API'den gelecek)
        const ocrData = {
            belgeTuru: 'fis',           // Yazar Kasa / Perakende SatÄ±ÅŸ FiÅŸi
            masrafTipi: 'normal',        // Normal Masraf
            firmaAdi: 'KARADENIZ SOFRASI',
            vergiNo: '1234567890',
            belgeNo: 'YKF-2024-847521',
            belgeTarihi: '2024-12-09',
            brutTutar: 585.00,
            kdvOrani: 10,
            kdvTutari: 53.18,
            netTutar: 531.82,
            masrafTuru: '770.01',        // Yemek Giderleri (restoran fiÅŸi olduÄŸu iÃ§in)
            ocrGuvenSkoru: 94
        };

        // OCR ile form alanlarÄ±nÄ± otomatik doldur
        function fillFormFromOCR() {
            // 1. Belge TÃ¼rÃ¼ ve Masraf Tipi otomatik doldur
            document.getElementById('belgeTuru').value = ocrData.belgeTuru;
            document.getElementById('masrafTipi').value = ocrData.masrafTipi;

            // 2. Belge Bilgileri otomatik doldur
            document.getElementById('firmaAdi').value = ocrData.firmaAdi;
            document.getElementById('vergiNo').value = ocrData.vergiNo;
            document.getElementById('belgeNo').value = ocrData.belgeNo;
            document.getElementById('belgeTarihi').value = ocrData.belgeTarihi;

            // 3. Tutar Bilgileri otomatik doldur
            document.getElementById('brutTutar').value = ocrData.brutTutar.toFixed(2);
            document.getElementById('kdvOrani').value = ocrData.kdvOrani;
            document.getElementById('kdvTutari').value = ocrData.kdvTutari.toFixed(2);
            document.getElementById('netTutar').value = ocrData.netTutar.toFixed(2);

            // 4. Masraf TÃ¼rÃ¼ / Hesap Kodu otomatik doldur ve KÄ°LÄ°TLE
            const hesapKoduSelect = document.getElementById('hesapKodu');
            hesapKoduSelect.value = ocrData.masrafTuru;
            hesapKoduSelect.disabled = true;
            hesapKoduSelect.style.backgroundColor = '#e8f5e9';
            hesapKoduSelect.style.border = '2px solid #4CAF50';
            hesapKoduSelect.style.cursor = 'not-allowed';

            // Masraf tÃ¼rÃ¼ alanÄ±na OCR kilidi bilgisi ekle
            addOCRLockIndicator();

            // Summary alanlarÄ±nÄ± gÃ¼ncelle
            document.getElementById('summaryBrut').textContent = ocrData.brutTutar.toFixed(2) + ' TL';
            document.getElementById('summaryKdv').textContent = ocrData.kdvTutari.toFixed(2) + ' TL';
            document.getElementById('summaryNet').textContent = ocrData.netTutar.toFixed(2) + ' TL';
            document.getElementById('summaryTotal').textContent = ocrData.brutTutar.toFixed(2) + ' TL';

            // OCR gÃ¼ven skoru gÃ¼ncelle
            document.getElementById('ocrConfidenceTag').textContent = '%' + ocrData.ocrGuvenSkoru + ' BaÅŸarÄ±lÄ±';
        }

        // OCR kilidi gÃ¶stergesi ekle
        function addOCRLockIndicator() {
            const hesapKoduGroup = document.getElementById('hesapKodu').closest('.form-group');

            // Ã–nceki kilit gÃ¶stergesini kaldÄ±r
            const existingLock = hesapKoduGroup.querySelector('.ocr-lock-indicator');
            if (existingLock) existingLock.remove();

            // Yeni kilit gÃ¶stergesi ekle
            const lockIndicator = document.createElement('div');
            lockIndicator.className = 'ocr-lock-indicator';
            lockIndicator.innerHTML = `
                <span style="display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; padding: 6px 12px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 6px; font-size: 12px; color: #2e7d32; border: 1px solid #a5d6a7;">
                    ğŸ”’ OCR tarafÄ±ndan otomatik belirlendi (DeÄŸiÅŸtirilemez)
                </span>
            `;
            hesapKoduGroup.appendChild(lockIndicator);
        }

        // OCR iÅŸlemi simÃ¼lasyonu (Tekrar Oku butonu iÃ§in)
        function processOCR() {
            const ocrProcessing = document.getElementById('ocrProcessing');
            const ocrSuccess = document.getElementById('ocrSuccess');
            const documentPreviewCard = document.getElementById('documentPreviewCard');

            // Ä°ÅŸleniyor animasyonunu gÃ¶ster
            documentPreviewCard.style.display = 'none';
            ocrSuccess.style.display = 'none';
            ocrProcessing.style.display = 'block';

            // AdÄ±m adÄ±m iÅŸleme simÃ¼lasyonu
            const steps = ['step1', 'step2', 'step3', 'step4'];
            let currentStep = 0;

            const stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(stepInterval);

                    // Ä°ÅŸlem tamamlandÄ± - formu doldur
                    setTimeout(() => {
                        ocrProcessing.style.display = 'none';
                        ocrSuccess.style.display = 'block';
                        documentPreviewCard.style.display = 'block';

                        // Form alanlarÄ±nÄ± doldur
                        fillFormFromOCR();

                        // BaÅŸarÄ± mesajÄ±
                        showAlert('success', 'OCR baÅŸarÄ±lÄ±! TÃ¼m alanlar otomatik olarak dolduruldu. Masraf tÃ¼rÃ¼ gÃ¶rsele gÃ¶re belirlendi ve kilitlendi.');
                    }, 500);
                }
            }, 400);
        }

        // Sayfa yÃ¼klendiÄŸinde OCR verilerini otomatik doldur
        document.addEventListener('DOMContentLoaded', function() {
            // YÃ¶netici kontrolÃ¼nÃ¼ yap
            checkManagerView();

            // Sayfa yÃ¼klendiÄŸinde OCR verilerini otomatik doldur
            setTimeout(() => {
                fillFormFromOCR();
            }, 500);
        });

        // Show/hide fields based on belge tÃ¼rÃ¼
        document.getElementById('belgeTuru').addEventListener('change', function() {
            const yurtdisiAlanlari = document.getElementById('yurtdisiAlanlari');
            const tevkifatAlanlari = document.getElementById('tevkifatAlanlari');

            // YurtdÄ±ÅŸÄ± alanlarÄ±
            if (this.value === 'yurtdisi') {
                yurtdisiAlanlari.style.display = 'block';
            } else {
                yurtdisiAlanlari.style.display = 'none';
            }

            // Tevkifat alanlarÄ±
            if (this.value === 'tevkifatli') {
                tevkifatAlanlari.style.display = 'block';
            } else {
                tevkifatAlanlari.style.display = 'none';
                document.getElementById('tevkifatOrani').value = '0';
                document.getElementById('tevkifatTutari').value = '';
            }
        });

        // Show/hide TaÅŸÄ±t Gideri alanlarÄ± based on hesap kodu
        document.getElementById('hesapKodu').addEventListener('change', function() {
            const tasitGideriAlanlari = document.getElementById('tasitGideriAlanlari');

            if (this.value === '770.07') {
                tasitGideriAlanlari.style.display = 'block';
                updateTasitGideri();
            } else {
                tasitGideriAlanlari.style.display = 'none';
                document.getElementById('giderKismi').value = '';
                document.getElementById('kkegKismi').value = '';
            }
        });

        // Tevkifat hesaplama fonksiyonu
        function updateTevkifat() {
            const kdvTutari = parseFloat(document.getElementById('kdvTutari').value) || 0;
            const tevkifatOrani = document.getElementById('tevkifatOrani').value;

            if (tevkifatOrani && tevkifatOrani !== '0') {
                const [pay, payda] = tevkifatOrani.split('/').map(Number);
                const tevkifatTutari = kdvTutari * (pay / payda);
                document.getElementById('tevkifatTutari').value = tevkifatTutari.toFixed(2);
            } else {
                document.getElementById('tevkifatTutari').value = '';
            }
        }

        // TaÅŸÄ±t Gideri %70/%30 ayrÄ±mÄ± hesaplama fonksiyonu
        function updateTasitGideri() {
            const netTutar = parseFloat(document.getElementById('netTutar').value) || 0;
            const hesapKodu = document.getElementById('hesapKodu').value;

            if (hesapKodu === '770.07' && netTutar > 0) {
                const giderKismi = netTutar * 0.70;
                const kkegKismi = netTutar * 0.30;

                document.getElementById('giderKismi').value = giderKismi.toFixed(2);
                document.getElementById('kkegKismi').value = kkegKismi.toFixed(2);
            }
        }

        // Override updateAmountSummary to also update tevkifat and tasit gideri
        const originalUpdateAmountSummary = window.updateAmountSummary || function() {};
        window.updateAmountSummary = function() {
            originalUpdateAmountSummary();

            // Tutar alanlarÄ± gÃ¼ncelle
            const brutTutar = parseFloat(document.getElementById('brutTutar').value) || 0;
            const kdvOrani = parseFloat(document.getElementById('kdvOrani').value) || 0;

            const kdvHaricTutar = brutTutar / (1 + kdvOrani / 100);
            const kdvTutari = brutTutar - kdvHaricTutar;

            document.getElementById('kdvTutari').value = kdvTutari.toFixed(2);
            document.getElementById('netTutar').value = kdvHaricTutar.toFixed(2);

            // Summary alanlarÄ± gÃ¼ncelle
            document.getElementById('summaryBrut').textContent = brutTutar.toFixed(2) + ' TL';
            document.getElementById('summaryKdv').textContent = kdvTutari.toFixed(2) + ' TL';
            document.getElementById('summaryNet').textContent = kdvHaricTutar.toFixed(2) + ' TL';
            document.getElementById('summaryTotal').textContent = brutTutar.toFixed(2) + ' TL';

            // Tevkifat gÃ¼ncelle
            if (document.getElementById('belgeTuru').value === 'tevkifatli') {
                updateTevkifat();
            }

            // TaÅŸÄ±t gideri gÃ¼ncelle
            if (document.getElementById('hesapKodu').value === '770.07') {
                updateTasitGideri();
            }

            // Tutar limiti kontrolÃ¼
            checkTutarLimiti(brutTutar);
        };

        // ============================================
        // KURAL SETLERÄ° - VALÄ°DASYON FONKSÄ°YONLARI
        // ============================================

        // Kural 1: Tutar Limiti KontrolÃ¼ (DeÄŸiÅŸtirilebilir)
        const TUTAR_LIMITI = 50000; // TL (ayarlanabilir)

        function checkTutarLimiti(tutar) {
            const alertContainer = document.getElementById('alertContainer');
            const existingLimitAlert = document.getElementById('limitAlert');

            if (tutar > TUTAR_LIMITI) {
                if (!existingLimitAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'limitAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">ğŸš«</span>
                        <div>
                            <strong>Tutar Limiti AÅŸÄ±ldÄ±!</strong><br>
                            Masraf tutarÄ± belirlenen limit olan <strong>${TUTAR_LIMITI.toLocaleString('tr-TR')} TL</strong>'yi aÅŸmaktadÄ±r.
                            Bu masraf otomatik olarak onaylanamaz.
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
            } else if (existingLimitAlert) {
                existingLimitAlert.remove();
            }
        }

        // Kural 2: Kabul Edilmeyen Gider Kalemleri (DeÄŸiÅŸtirilebilir)
        const REDDEDILEN_GIDER_KALEMLERI = [
            'tekel', 'alkol', 'sigara', 'tÃ¼tÃ¼n', 'iÃ§ki', 'bira', 'ÅŸarap', 'rakÄ±',
            'viski', 'votka', 'kumar', 'bahis', 'casino'
        ];

        function checkYasakliGiderKalemi(aciklama) {
            const alertContainer = document.getElementById('alertContainer');
            const existingGiderAlert = document.getElementById('giderAlert');
            const lowercaseAciklama = aciklama.toLowerCase();

            const bulunanYasakli = REDDEDILEN_GIDER_KALEMLERI.find(kalem =>
                lowercaseAciklama.includes(kalem)
            );

            if (bulunanYasakli) {
                if (!existingGiderAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'giderAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">â›”</span>
                        <div>
                            <strong>Kabul Edilmeyen Gider Kalemi!</strong><br>
                            AÃ§Ä±klamada kabul edilmeyen gider kalemi tespit edildi: <strong>"${bulunanYasakli}"</strong><br>
                            <small>Bu tÃ¼r masraflar ÅŸirket politikasÄ± gereÄŸi kabul edilmemektedir.</small>
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
                return false;
            } else if (existingGiderAlert) {
                existingGiderAlert.remove();
            }
            return true;
        }

        // AÃ§Ä±klama alanÄ± kontrolÃ¼
        document.getElementById('aciklama').addEventListener('input', function() {
            checkYasakliGiderKalemi(this.value);
        });

        // Kural 3: MÃ¼kerrer Fatura KontrolÃ¼ (SimÃ¼lasyon)
        // GerÃ§ek uygulamada API Ã§aÄŸrÄ±sÄ± ile kontrol edilecek
        const GECMIS_FATURALAR = [
            { firmaAdi: 'KARADENIZ SOFRASI', belgeNo: 'YKF-2024-847520', belgeTarihi: '2024-12-08' },
            { firmaAdi: 'MIGROS', belgeNo: 'F-2024-001234', belgeTarihi: '2024-12-07' }
        ];

        function checkMukerrerFatura() {
            const firmaAdi = document.getElementById('firmaAdi').value.toUpperCase();
            const belgeNo = document.getElementById('belgeNo').value;
            const belgeTarihi = document.getElementById('belgeTarihi').value;

            const alertContainer = document.getElementById('alertContainer');
            const existingMukerrerAlert = document.getElementById('mukerrerAlert');

            const mukerrer = GECMIS_FATURALAR.find(f =>
                f.firmaAdi.toUpperCase() === firmaAdi &&
                f.belgeNo === belgeNo &&
                f.belgeTarihi === belgeTarihi
            );

            if (mukerrer) {
                if (!existingMukerrerAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'mukerrerAlert';
                    alert.className = 'alert alert-error';
                    alert.innerHTML = `
                        <span class="alert-icon">âš ï¸</span>
                        <div>
                            <strong>MÃ¼kerrer Fatura UyarÄ±sÄ±!</strong><br>
                            Bu fatura daha Ã¶nce sisteme girilmiÅŸ gÃ¶rÃ¼nÃ¼yor.<br>
                            <small>Firma: ${firmaAdi} | Belge No: ${belgeNo} | Tarih: ${belgeTarihi}</small>
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
                return false;
            } else if (existingMukerrerAlert) {
                existingMukerrerAlert.remove();
            }
            return true;
        }

        // Belge alanlarÄ± deÄŸiÅŸtiÄŸinde mÃ¼kerrer kontrolÃ¼
        ['firmaAdi', 'belgeNo', 'belgeTarihi'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('change', checkMukerrerFatura);
        });

        // Kural 4: Åirket EÅŸleÅŸme KontrolÃ¼
        // Ã‡alÄ±ÅŸanÄ±n bordro ÅŸirketi ile fatura ÅŸirketi uyumlu olmalÄ±
        const KULLANICI_BORDRO_SIRKETI = 'flo_teknoloji'; // Ã–rnek: Login'den gelecek
        const SIRKET_VKN_ESLESMESI = {
            'flo_magazacilik': ['1234567890', '9876543210'],
            'flo_teknoloji': ['1111111111', '2222222222'],
            'turuncu': ['3333333333', '4444444444'],
            'flo_ic_dis': ['5555555555', '6666666666']
        };

        function checkSirketEslesmesi() {
            const secilenSirket = document.getElementById('sirket').value;
            const alertContainer = document.getElementById('alertContainer');
            const existingSirketAlert = document.getElementById('sirketAlert');

            if (secilenSirket !== KULLANICI_BORDRO_SIRKETI) {
                if (!existingSirketAlert) {
                    const alert = document.createElement('div');
                    alert.id = 'sirketAlert';
                    alert.className = 'alert alert-warning';
                    alert.innerHTML = `
                        <span class="alert-icon">âš ï¸</span>
                        <div>
                            <strong>Åirket UyumsuzluÄŸu!</strong><br>
                            Bordro ÅŸirketiniz ile seÃ§ilen ÅŸirket farklÄ±.
                            FarklÄ± ÅŸirket adÄ±na masraf giriÅŸi iÃ§in gerekÃ§e belirtmeniz gerekmektedir.
                        </div>
                    `;
                    alertContainer.appendChild(alert);
                }
            } else if (existingSirketAlert) {
                existingSirketAlert.remove();
            }
        }

        document.getElementById('sirket').addEventListener('change', checkSirketEslesmesi);

        // Form submit validasyonu
        const originalSubmitMasrafForm = window.submitMasrafForm || function() {};
        window.submitMasrafForm = function() {
            const brutTutar = parseFloat(document.getElementById('brutTutar').value) || 0;
            const aciklama = document.getElementById('aciklama').value;
            const belgeTuru = document.getElementById('belgeTuru').value;

            // Disabled select'in deÄŸerini al (OCR tarafÄ±ndan kilitlenmiÅŸ olabilir)
            const hesapKoduSelect = document.getElementById('hesapKodu');
            const hesapKodu = hesapKoduSelect.value;

            // Zorunlu alan kontrolleri
            if (!belgeTuru) {
                showValidationAlert('LÃ¼tfen belge tÃ¼rÃ¼nÃ¼ seÃ§iniz.', 'error');
                return;
            }
            if (!hesapKodu) {
                showValidationAlert('LÃ¼tfen masraf tÃ¼rÃ¼ / hesap kodunu seÃ§iniz.', 'error');
                return;
            }
            if (!aciklama.trim()) {
                showValidationAlert('Masraf aÃ§Ä±klamasÄ± zorunludur.', 'error');
                return;
            }
            if (brutTutar <= 0) {
                showValidationAlert('GeÃ§erli bir tutar giriniz.', 'error');
                return;
            }

            // Kural seti kontrolleri
            if (brutTutar > TUTAR_LIMITI) {
                showValidationAlert('Tutar limiti aÅŸÄ±ldÄ±ÄŸÄ± iÃ§in bu masraf gÃ¶nderilemez.', 'error');
                return;
            }

            if (!checkYasakliGiderKalemi(aciklama)) {
                showValidationAlert('Kabul edilmeyen gider kalemi iÃ§eren masraf gÃ¶nderilemez.', 'error');
                return;
            }

            if (!checkMukerrerFatura()) {
                showValidationAlert('MÃ¼kerrer fatura tespit edildi. LÃ¼tfen kontrol ediniz.', 'error');
                return;
            }

            // TÃ¼m kontroller geÃ§ti, formu gÃ¶nder
            showAlert('success', 'Masraf talebiniz baÅŸarÄ±yla onaya gÃ¶nderildi!');
            setTimeout(() => {
                window.location.href = 'masraf-listesi.html';
            }, 2000);
        };

        // Alert gÃ¶sterme fonksiyonu (main.js ile uyumlu)
        // Not: main.js'deki showAlert(type, message) fonksiyonunu kullanÄ±yoruz
        // Bu sayfaya Ã¶zel validasyon alertleri iÃ§in ayrÄ± bir fonksiyon tanÄ±mlÄ±yoruz
        function showValidationAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span class="alert-icon">${type === 'error' ? 'âŒ' : 'âœ…'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 18px;">Ã—</button>
            `;
            alertContainer.prepend(alert);

            if (type === 'success') {
                setTimeout(() => alert.remove(), 5000);
            }
        }

        // YÃ¶netici gÃ¶rÃ¼nÃ¼mÃ¼ kontrolÃ¼
        function checkManagerView() {
            const urlParams = new URLSearchParams(window.location.search);
            const isManagerRole = urlParams.get('role') === 'manager';

            if (isManagerRole) {
                document.getElementById('sidebarEmployee').style.display = 'none';
                document.getElementById('sidebarManager').style.display = 'block';
            }
        }

    </script>
</body>
</html>
